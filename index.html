<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운동 방 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Pretendard', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'pastel': {
                            'pink': '#FFE1E6',
                            'purple': '#E8D5FF', 
                            'blue': '#D1E7FF',
                            'green': '#D4F1D4',
                            'yellow': '#FFF2CC',
                            'orange': '#FFE4CC',
                            'coral': '#FFD6CC',
                            'mint': '#CCFFF2',
                            'lavender': '#F0E6FF',
                            'peach': '#FFEBCC'
                        },
                        'soft': {
                            'pink': '#FF9FB2',
                            'purple': '#C49AFF',
                            'blue': '#9AC8FF',
                            'green': '#9AE69A',
                            'yellow': '#FFE066',
                            'orange': '#FFB366',
                            'coral': '#FF9A66',
                            'mint': '#66FFE0',
                            'lavender': '#D9B3FF',
                            'peach': '#FFD199'
                        },
                        'primary': {
                            50: '#F0E6FF',
                            100: '#E8D5FF',
                            200: '#D1ABFF',
                            300: '#BA81FF',
                            400: '#A357FF',
                            500: '#8B2DFF',
                            600: '#7024CC',
                            700: '#541B99',
                            800: '#381266',
                            900: '#1C0933'
                        }
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                        '3xl': '2rem',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(139, 45, 255, 0.1)',
                        'soft-lg': '0 8px 30px rgba(139, 45, 255, 0.15)',
                        'pastel': '0 4px 15px rgba(255, 159, 178, 0.2)',
                    }
                }
            }
        }
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: 'Pretendard', system-ui, sans-serif;
            background: linear-gradient(135deg, #F0E6FF 0%, #E8D5FF 50%, #D1E7FF 100%);
            min-height: 100vh;
        }
        
        .shadow-card {
            box-shadow: 0 8px 25px rgba(139, 45, 255, 0.08);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .shadow-card-hover {
            box-shadow: 0 12px 35px rgba(139, 45, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .modal {
            display: none;
            backdrop-filter: blur(8px);
        }
        .modal.active {
            display: flex;
        }
        
        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .status-active { 
            background: linear-gradient(135deg, #9AE69A, #66FFE0);
            color: #1a5a1a;
        }
        .status-weekly-warning { 
            background: linear-gradient(135deg, #FFE066, #FFD199);
            color: #8B4513;
        }
        .status-monthly-warning { 
            background: linear-gradient(135deg, #FFB366, #FF9A66);
            color: #8B2500;
        }
        .status-removal { 
            background: linear-gradient(135deg, #FF9FB2, #FFD6CC);
            color: #8B0000;
        }
        .status-inactive { 
            background: linear-gradient(135deg, #E5E7EB, #D1D5DB);
            color: #4B5563;
        }
        
        .calendar-day {
            min-height: 85px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
        }
        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 45, 255, 0.1);
        }
        .calendar-day.has-activity {
            background: linear-gradient(135deg, #D1E7FF, #CCFFF2);
            border: 2px solid rgba(139, 45, 255, 0.2);
        }
        .calendar-day.has-activity:hover {
            background: linear-gradient(135deg, #9AC8FF, #66FFE0);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 45, 255, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8B2DFF, #A357FF);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 45, 255, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7024CC, #8B2DFF);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(139, 45, 255, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #FF9FB2, #FFD6CC);
            color: #8B0000;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #FF8FA5, #FFC2B8);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #9AE69A, #66FFE0);
            color: #1a5a1a;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #7DD87D, #4DFFD4);
            transform: translateY(-1px);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 45, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(139, 45, 255, 0.3);
            box-shadow: 0 0 0 3px rgba(139, 45, 255, 0.1);
        }
        
        .card-gradient {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            backdrop-filter: blur(15px);
        }
        
        .stats-card {
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* 모바일 탭 스타일 */
        .tab-active {
            background: linear-gradient(135deg, #8B5DFF 0%, #FF6B9D 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(139, 93, 255, 0.3);
        }

        /* 모바일 최적화 */
        @media (max-width: 1024px) {
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-full {
                display: block !important;
            }
            
            /* 모달 모바일 최적화 */
            .modal .card-gradient {
                margin: 0.5rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* 버튼 터치 최적화 */
            button, .cursor-pointer {
                min-height: 44px;
            }
            
            /* 입력 필드 터치 최적화 */
            input, select, textarea {
                min-height: 44px;
                font-size: 16px; /* iOS 줌 방지 */
            }
            
            /* 패딩 조정 */
            .card-gradient {
                padding: 1rem;
            }
            
            /* 그리드 간격 조정 */
            .space-y-6 > * + * {
                margin-top: 1rem;
            }
        }

        /* 터치 디바이스 최적화 */
        @media (hover: none) and (pointer: coarse) {
            .hover\\:scale-\\[1\\.02\\]:hover {
                transform: none;
            }
            
            .hover\\:shadow-soft:hover {
                box-shadow: 0 4px 20px rgba(139, 45, 255, 0.1);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 로딩 인디케이터 -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-primary-50 to-primary-100 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 bg-gradient-to-br from-soft-purple to-soft-pink rounded-2xl mx-auto mb-4 flex items-center justify-center animate-pulse">
                <span class="text-2xl">💪</span>
            </div>
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"></div>
            <p class="text-primary-700 font-medium">로딩 중...</p>
            <p id="loadingStatus" class="text-primary-500 text-sm mt-2">데이터를 불러오고 있습니다</p>
        </div>
    </div>

    <!-- 로그인 화면 -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="card-gradient p-10 rounded-3xl shadow-soft-lg w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-soft-purple to-soft-pink rounded-2xl mx-auto mb-4 flex items-center justify-center">
                    <span class="text-3xl">💪</span>
                </div>
                <h1 class="text-2xl font-bold text-primary-800 mb-2">운동 방 관리 시스템</h1>
                <p class="text-primary-600 text-sm font-medium">건강한 운동 습관을 함께 만들어가요</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">아이디</label>
                    <input type="text" id="loginId" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="아이디를 입력하세요" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">비밀번호</label>
                    <input type="password" id="loginPassword" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="비밀번호를 입력하세요" required>
                </div>
                <button type="submit" class="btn-primary w-full text-white py-3 px-4 rounded-xl font-semibold">
                    로그인
                </button>
            </form>
            <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden bg-red-50 p-3 rounded-xl"></div>
            
        </div>
    </div>

    <!-- 메인 대시보드 -->
    <div id="mainDashboard" class="hidden min-h-screen">
        <!-- 헤더 -->
        <header class="card-gradient shadow-soft border-b border-white/20 backdrop-blur-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3 lg:py-5">
                    <div class="flex items-center space-x-2 lg:space-x-3">
                        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-gradient-to-br from-soft-purple to-soft-pink rounded-xl flex items-center justify-center">
                            <span class="text-base lg:text-lg">💪</span>
                        </div>
                        <div>
                            <h1 class="text-lg lg:text-xl font-bold text-primary-800">운동 방 관리 시스템</h1>
                            <p class="text-primary-600 text-xs hidden sm:block">건강한 운동 습관을 함께 만들어가요</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1 lg:space-x-3">
                        <div class="bg-pastel-lavender px-2 lg:px-3 py-1 lg:py-2 rounded-lg lg:rounded-xl">
                            <span id="userInfo" class="text-xs lg:text-sm font-semibold text-primary-700"></span>
                        </div>
                        
                        <!-- 데스크톱 버튼들 -->
                        <div class="hidden lg:flex items-center space-x-3">
                            <button id="forceInitBtn" class="btn-secondary px-3 py-2 rounded-xl text-sm font-medium hidden">
                                🔄 Firebase 초기화
                            </button>
                            <button id="changePasswordBtn" class="bg-gradient-to-r from-pastel-coral to-pastel-pink text-primary-800 px-4 py-2 rounded-xl font-medium hover:shadow-soft transition-all">
                                🔐 비밀번호 변경
                            </button>
                            <button id="exportBtn" class="bg-gradient-to-r from-pastel-green to-pastel-mint text-primary-800 px-4 py-2 rounded-xl font-medium hover:shadow-soft transition-all hidden">
                                📁 데이터 내보내기
                            </button>
                            <button id="reportBtn" class="btn-primary text-white px-4 py-2 rounded-xl font-medium">
                                📊 리포트 보기
                            </button>
                            <button id="logoutBtn" class="bg-gradient-to-r from-gray-400 to-gray-500 text-white px-4 py-2 rounded-xl hover:from-gray-500 hover:to-gray-600 transition-all font-medium">
                                로그아웃
                            </button>
                        </div>
                        
                        <!-- 모바일 메뉴 버튼 -->
                        <div class="lg:hidden">
                            <button id="mobileMenuBtn" class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center text-primary-800">
                                <span class="text-lg">⋯</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 모바일 메뉴 -->
                <div id="mobileMenu" class="lg:hidden hidden pb-3">
                    <div class="flex flex-wrap gap-2">
                        <button id="changePasswordBtnMobile" class="flex-1 bg-gradient-to-r from-pastel-coral to-pastel-pink text-primary-800 px-3 py-2 rounded-lg text-xs font-medium">
                            🔐 비밀번호
                        </button>
                        <button id="exportBtnMobile" class="flex-1 bg-gradient-to-r from-pastel-green to-pastel-mint text-primary-800 px-3 py-2 rounded-lg text-xs font-medium hidden">
                            📁 내보내기
                        </button>
                        <button id="reportBtnMobile" class="flex-1 btn-primary text-white px-3 py-2 rounded-lg text-xs font-medium">
                            📊 리포트
                        </button>
                        <button id="logoutBtnMobile" class="flex-1 bg-gradient-to-r from-gray-400 to-gray-500 text-white px-3 py-2 rounded-lg text-xs font-medium">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-3 sm:py-6">
            <!-- 모바일 탭 네비게이션 -->
            <div class="lg:hidden mb-4">
                <div class="flex bg-white/20 backdrop-blur-sm rounded-xl p-1">
                    <button id="tabMain" class="flex-1 py-2 px-3 text-sm font-medium rounded-lg transition-all tab-active">
                        📊 메인
                    </button>
                    <button id="tabMembers" class="flex-1 py-2 px-3 text-sm font-medium rounded-lg transition-all">
                        👥 멤버
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-3 lg:gap-6">
                <!-- 왼쪽 컬럼 (메인 영역) -->
                <div id="mainContent" class="lg:col-span-3 space-y-3 lg:space-y-6">
                    <!-- 공지사항 -->
                    <div class="card-gradient rounded-2xl shadow-soft p-6">
                        <div class="flex justify-between items-center mb-5">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-soft-yellow to-soft-orange rounded-lg flex items-center justify-center">
                                    <span class="text-sm">📢</span>
                                </div>
                                <h2 class="text-lg font-bold text-primary-800">공지사항</h2>
                            </div>
                            <button id="editNoticeBtn" class="btn-primary text-white px-4 py-2 rounded-xl text-sm font-medium hidden">
                                ✏️ 공지수정
                            </button>
                        </div>
                        <div id="noticeContent" class="text-primary-700">
                            <div class="bg-gradient-to-r from-pastel-blue to-pastel-mint border-l-4 border-soft-blue p-5 rounded-xl">
                                <div class="flex items-start space-x-3">
                                    <span class="text-lg">💡</span>
                                    <div>
                                        <p class="text-sm font-medium text-primary-800">
                                            <span class="bg-soft-blue text-white px-2 py-1 rounded-lg text-xs font-bold">[필독]</span> 
                                            <span class="ml-2">운동 방 관리 시스템에 오신 것을 환영합니다!</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 월별 달력 -->
                    <div class="card-gradient rounded-2xl shadow-soft p-6">
                        <div class="flex justify-between items-center mb-5">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-soft-green to-soft-mint rounded-lg flex items-center justify-center">
                                    <span class="text-sm">📅</span>
                                </div>
                                <h2 class="text-lg font-bold text-primary-800">활동 달력</h2>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button id="prevMonth" class="p-2 hover:bg-pastel-purple rounded-xl transition-all duration-300 hover:scale-105">
                                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <div class="bg-pastel-lavender px-4 py-2 rounded-xl">
                                    <span id="currentMonth" class="text-lg font-bold text-primary-800"></span>
                                </div>
                                <button id="nextMonth" class="p-2 hover:bg-pastel-purple rounded-xl transition-all duration-300 hover:scale-105">
                                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="calendar" class="grid grid-cols-7 gap-2">
                            <!-- 달력이 여기에 동적으로 생성됩니다 -->
                        </div>
                    </div>

                    <!-- 주간 대시보드 & 월간 리포트 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 주간 대시보드 -->
                        <div class="card-gradient rounded-2xl shadow-soft p-6">
                            <div class="flex justify-between items-center mb-5">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-br from-soft-blue to-soft-mint rounded-lg flex items-center justify-center">
                                        <span class="text-sm">📊</span>
                                    </div>
                                    <h2 class="text-lg font-bold text-primary-800">주간 대시보드</h2>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="prevWeek" class="p-2 hover:bg-pastel-blue rounded-lg transition-all duration-300 hover:scale-105">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="bg-pastel-blue px-3 py-1 rounded-lg">
                                        <span id="currentWeek" class="text-xs font-bold text-primary-800 min-w-[120px] text-center block"></span>
                                    </div>
                                    <button id="nextWeek" class="p-2 hover:bg-pastel-blue rounded-lg transition-all duration-300 hover:scale-105">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 주간 통계 -->
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="stats-card bg-gradient-to-br from-pastel-blue to-pastel-mint p-4 rounded-xl">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-sm">💪</span>
                                            <div class="text-xs text-primary-700 font-semibold">총 운동 참여</div>
                                        </div>
                                        <div id="weeklyWorkoutCount" class="text-xl font-bold text-primary-800">0회</div>
                                    </div>
                                    <div class="stats-card bg-gradient-to-br from-pastel-green to-pastel-mint p-4 rounded-xl">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-sm">🎉</span>
                                            <div class="text-xs text-primary-700 font-semibold">총 벙 참여</div>
                                        </div>
                                        <div id="weeklyMeetingCount" class="text-xl font-bold text-primary-800">0회</div>
                                    </div>
                                </div>
                                
                                <!-- 주간 미달자 -->
                                <div class="bg-pastel-yellow p-4 rounded-xl">
                                    <h4 class="text-sm font-bold text-primary-800 mb-3 flex items-center space-x-2">
                                        <span>⚠️</span>
                                        <span>주간 운동 미달자 (2회 미만)</span>
                                    </h4>
                                    <div id="weeklyUnderperformers" class="space-y-2 max-h-32 overflow-y-auto">
                                        <!-- 미달자 목록이 여기에 표시됩니다 -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 월간 리포트 -->
                        <div class="card-gradient rounded-2xl shadow-soft p-6">
                            <div class="flex justify-between items-center mb-5">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-br from-soft-purple to-soft-pink rounded-lg flex items-center justify-center">
                                        <span class="text-sm">📈</span>
                                    </div>
                                    <h2 class="text-lg font-bold text-primary-800">월간 리포트</h2>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="prevReportMonth" class="p-2 hover:bg-pastel-purple rounded-lg transition-all duration-300 hover:scale-105">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="bg-pastel-purple px-3 py-1 rounded-lg">
                                        <span id="currentReportMonth" class="text-xs font-bold text-primary-800 min-w-[80px] text-center block"></span>
                                    </div>
                                    <button id="nextReportMonth" class="p-2 hover:bg-pastel-purple rounded-lg transition-all duration-300 hover:scale-105">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 월간 통계 -->
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="stats-card bg-gradient-to-br from-pastel-purple to-pastel-lavender p-4 rounded-xl">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-sm">🏋️</span>
                                            <div class="text-xs text-primary-700 font-semibold">월간 운동</div>
                                        </div>
                                        <div id="monthlyWorkoutCount" class="text-xl font-bold text-primary-800">0회</div>
                                    </div>
                                    <div class="stats-card bg-gradient-to-br from-pastel-orange to-pastel-peach p-4 rounded-xl">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-sm">🍻</span>
                                            <div class="text-xs text-primary-700 font-semibold">월간 벙</div>
                                        </div>
                                        <div id="monthlyMeetingCount" class="text-xl font-bold text-primary-800">0회</div>
                                    </div>
                                </div>
                                
                                <!-- 월간 미달자 -->
                                <div class="bg-pastel-coral p-4 rounded-xl">
                                    <h4 class="text-sm font-bold text-primary-800 mb-3 flex items-center space-x-2">
                                        <span>🚨</span>
                                        <span>월간 벙 미달자 (1회 미만)</span>
                                    </h4>
                                    <div id="monthlyUnderperformers" class="space-y-2 max-h-32 overflow-y-auto">
                                        <!-- 미달자 목록이 여기에 표시됩니다 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 오른쪽 패널 (사이드바) -->
                <div id="memberContent" class="lg:col-span-1 hidden lg:block">
                    <div class="card-gradient rounded-2xl shadow-soft p-6">
                        <div class="flex justify-between items-center mb-5">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-soft-pink to-soft-coral rounded-lg flex items-center justify-center">
                                    <span class="text-sm">👥</span>
                                </div>
                                <h2 class="text-lg font-bold text-primary-800">멤버 관리</h2>
                            </div>
                            <button id="addMemberBtn" class="btn-success text-white px-4 py-2 rounded-xl text-sm font-medium">
                                ➕ 추가
                            </button>
                        </div>
                        
                        <!-- 고급 필터 -->
                        <div class="mb-5 space-y-3">
                            <!-- 검색 -->
                            <div class="relative">
                                <input type="text" id="memberSearch" placeholder="🔍 멤버 검색 (이름, 닉네임)" 
                                       class="input-field w-full px-4 py-3 pl-10 rounded-xl text-sm font-medium focus:outline-none">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-primary-400">
                                    🔍
                                </div>
                            </div>
                            
                            <!-- 필터 옵션들 -->
                            <div class="grid grid-cols-2 gap-2">
                                <select id="statusFilter" class="input-field px-3 py-2 rounded-lg text-xs font-medium focus:outline-none">
                                    <option value="all">🌟 모든 상태</option>
                                    <option value="active">🟢 활동중</option>
                                    <option value="weekly-warning">🟡 주간경고</option>
                                    <option value="monthly-warning">🟠 월간경고</option>
                                    <option value="removal">🔴 강퇴대상</option>
                                    <option value="inactive">⚫ 비활성</option>
                                </select>
                                
                                <select id="roleFilter" class="input-field px-3 py-2 rounded-lg text-xs font-medium focus:outline-none">
                                    <option value="all">👥 모든 역할</option>
                                    <option value="super_admin">👑 방장</option>
                                    <option value="admin">⭐ 부방장</option>
                                    <option value="member">👤 일반멤버</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <select id="sortFilter" class="input-field px-3 py-2 rounded-lg text-xs font-medium focus:outline-none">
                                    <option value="default">📋 기본순</option>
                                    <option value="name">🔤 이름순</option>
                                    <option value="joinDate">📅 가입일순</option>
                                    <option value="activity">📊 활동순</option>
                                    <option value="status">⚠️ 상태순</option>
                                </select>
                                
                                <select id="periodFilter" class="input-field px-3 py-2 rounded-lg text-xs font-medium focus:outline-none">
                                    <option value="all">📆 전체기간</option>
                                    <option value="thisWeek">📅 이번주</option>
                                    <option value="thisMonth">📅 이번달</option>
                                    <option value="lastWeek">📅 지난주</option>
                                    <option value="lastMonth">📅 지난달</option>
                                </select>
                            </div>
                            
                            <!-- 빠른 필터 버튼들 -->
                            <div class="flex flex-wrap gap-1">
                                <button id="filterNewMembers" class="bg-pastel-mint text-primary-700 px-2 py-1 rounded-lg text-xs font-medium hover:bg-pastel-green transition-colors">
                                    🌱 신규멤버
                                </button>
                                <button id="filterActiveToday" class="bg-pastel-blue text-primary-700 px-2 py-1 rounded-lg text-xs font-medium hover:bg-pastel-purple transition-colors">
                                    💪 오늘활동
                                </button>
                                <button id="filterNeedAttention" class="bg-pastel-yellow text-primary-700 px-2 py-1 rounded-lg text-xs font-medium hover:bg-pastel-peach transition-colors">
                                    ⚠️ 주의필요
                                </button>
                                <button id="clearFilters" class="bg-pastel-gray text-primary-700 px-2 py-1 rounded-lg text-xs font-medium hover:bg-pastel-pink transition-colors">
                                    🔄 초기화
                                </button>
                            </div>
                            
                            <!-- 필터 결과 표시 -->
                            <div id="filterResults" class="text-xs text-primary-600 text-center py-2 bg-white/30 rounded-lg">
                                총 <span id="totalMembers">0</span>명 | 표시 <span id="filteredMembers">0</span>명
                            </div>
                        </div>

                        <!-- 멤버 목록 -->
                        <div id="memberList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <!-- 멤버 목록이 여기에 동적으로 생성됩니다 -->
                        </div>

                        <!-- 출석 랭킹 (새로운 기능) -->
                        <div class="mt-6 pt-6 border-t border-white/20">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-bold text-primary-800 flex items-center">
                                    <span class="text-base mr-2">🏆</span>
                                    랭킹 시스템
                                </h3>
                                <button id="refreshRanking" class="text-xs bg-pastel-mint text-primary-700 px-2 py-1 rounded-lg hover:bg-pastel-green transition-colors">
                                    🔄 새로고침
                                </button>
                            </div>
                            
                            <!-- 랭킹 탭 -->
                            <div class="mb-3">
                                <div class="flex space-x-1 mb-3">
                                    <button id="totalRankingTab" class="ranking-tab-active flex-1 text-xs py-2 px-3 rounded-lg font-medium bg-gradient-to-r from-pastel-blue to-pastel-mint text-primary-800">
                                        🏆 종합랭킹
                                    </button>
                                    <button id="workoutRankingTab" class="ranking-tab flex-1 text-xs py-2 px-3 rounded-lg font-medium bg-white/30 text-primary-600 hover:bg-white/50">
                                        💪 운동랭킹
                                    </button>
                                    <button id="meetingRankingTab" class="ranking-tab flex-1 text-xs py-2 px-3 rounded-lg font-medium bg-white/30 text-primary-600 hover:bg-white/50">
                                        🍻 벙랭킹
                                    </button>
                                </div>
                                
                                <!-- 랭킹 기간 선택 -->
                                <select id="rankingPeriod" class="input-field w-full px-3 py-2 rounded-lg text-xs font-medium focus:outline-none">
                                    <option value="week">📅 이번주</option>
                                    <option value="month">📅 이번달</option>
                                    <option value="all">📅 전체기간</option>
                                </select>
                            </div>
                            
                            <!-- 랭킹 목록 -->
                            <div id="attendanceRanking" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- 랭킹이 여기에 동적으로 생성됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 공지사항 수정 모달 -->
    <div id="noticeModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-soft-yellow to-soft-orange rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <span class="text-xl">📢</span>
                </div>
                <h3 class="text-xl font-bold text-primary-800">공지사항 수정</h3>
            </div>
            <form id="noticeForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">카테고리</label>
                    <select id="noticeCategory" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none">
                        <option value="필독">📌 [필독]</option>
                        <option value="정보">💡 [정보]</option>
                        <option value="공지">📣 [공지]</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">내용</label>
                    <textarea id="noticeText" rows="4" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none resize-none" placeholder="2-3줄의 공지사항을 입력하세요"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelNotice" class="px-6 py-3 text-primary-600 hover:text-primary-800 font-medium transition-colors rounded-xl hover:bg-pastel-purple">
                        취소
                    </button>
                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                        💾 저장
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 멤버 추가/수정 모달 -->
    <div id="memberModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-soft-pink to-soft-coral rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <span class="text-xl">👤</span>
                </div>
                <h3 id="memberModalTitle" class="text-xl font-bold text-primary-800">멤버 추가</h3>
            </div>
            <form id="memberForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">닉네임</label>
                    <input type="text" id="memberNickname" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="닉네임을 입력하세요" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">성명</label>
                    <input type="text" id="memberName" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="실명을 입력하세요" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">연락처</label>
                    <input type="tel" id="memberPhone" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="010-0000-0000" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">역할</label>
                    <select id="memberRole" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none">
                        <option value="member">👤 일반 멤버</option>
                        <option value="admin">⭐ 부방장</option>
                        <option value="super_admin">👑 방장</option>
                    </select>
                </div>
                <div class="bg-pastel-yellow p-4 rounded-xl">
                    <label class="flex items-center">
                        <input type="checkbox" id="memberInactive" class="mr-3 w-4 h-4 text-primary-600 rounded">
                        <span class="text-sm font-medium text-primary-800">🚫 활동 중지</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelMember" class="px-6 py-3 text-primary-600 hover:text-primary-800 font-medium transition-colors rounded-xl hover:bg-pastel-purple">
                        취소
                    </button>
                    <button type="button" id="deleteMember" class="btn-secondary px-6 py-3 rounded-xl font-medium hidden">
                        🗑️ 삭제
                    </button>
                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                        💾 저장
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 일일 활동 기록 모달 -->
    <div id="activityModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-soft-green to-soft-mint rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <span class="text-xl">📝</span>
                </div>
                <h3 id="activityModalTitle" class="text-xl font-bold text-primary-800">일일 활동 기록</h3>
            </div>
            <form id="activityForm">
                <!-- 고급 출석 체크 기능 -->
                <div class="space-y-4 mb-6">
                    <!-- 날짜 및 시간 설정 -->
                    <div class="bg-gradient-to-r from-pastel-mint to-pastel-blue p-4 rounded-xl">
                        <h4 class="text-sm font-bold text-primary-800 mb-3">📅 날짜 & 시간 설정</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-primary-700 mb-1">날짜</label>
                                <input type="date" id="activityDate" class="w-full text-xs px-2 py-1 rounded-lg border border-white/30 bg-white/50">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-primary-700 mb-1">시간대</label>
                                <select id="timeSlot" class="w-full text-xs px-2 py-1 rounded-lg border border-white/30 bg-white/50">
                                    <option value="all">🌅 전체</option>
                                    <option value="morning">🌄 오전 (6-12시)</option>
                                    <option value="afternoon">☀️ 오후 (12-18시)</option>
                                    <option value="evening">🌆 저녁 (18-24시)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button type="button" id="copyToWeek" class="flex-1 bg-white/60 text-primary-800 text-xs py-1 px-2 rounded-lg font-medium hover:bg-white/80 transition-all">
                                📅 이번주 전체 복사
                            </button>
                            <button type="button" id="scheduleReminder" class="flex-1 bg-white/60 text-primary-800 text-xs py-1 px-2 rounded-lg font-medium hover:bg-white/80 transition-all">
                                🔔 알림 예약
                            </button>
                        </div>
                    </div>

                    <!-- 빠른 액션 버튼들 -->
                    <div class="bg-gradient-to-r from-pastel-blue to-pastel-purple p-4 rounded-xl">
                        <h4 class="text-sm font-bold text-primary-800 mb-3">⚡ 빠른 체크</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-2">
                                <button type="button" id="selectAllWorkout" class="w-full btn-secondary text-xs py-2 px-3 rounded-lg">
                                    💪 운동 전체선택
                                </button>
                                <button type="button" id="clearAllWorkout" class="w-full bg-pastel-gray text-primary-700 text-xs py-2 px-3 rounded-lg hover:bg-pastel-pink transition-colors">
                                    ❌ 운동 전체해제
                                </button>
                            </div>
                            <div class="space-y-2">
                                <button type="button" id="selectAllMeeting" class="w-full btn-success text-xs py-2 px-3 rounded-lg">
                                    🍻 벙 전체선택
                                </button>
                                <button type="button" id="clearAllMeeting" class="w-full bg-pastel-gray text-primary-700 text-xs py-2 px-3 rounded-lg hover:bg-pastel-pink transition-colors">
                                    ❌ 벙 전체해제
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-white/20 space-y-2">
                            <button type="button" id="autoSelectLastWeek" class="w-full bg-gradient-to-r from-pastel-yellow to-pastel-peach text-primary-800 text-xs py-2 px-3 rounded-lg font-medium hover:shadow-soft transition-all">
                                🔮 지난주 참여자 자동선택
                            </button>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" id="selectHighAttendance" class="w-full bg-gradient-to-r from-pastel-green to-pastel-mint text-primary-800 text-xs py-1 px-2 rounded-lg font-medium">
                                    🏆 고참여자 선택
                                </button>
                                <button type="button" id="selectNeedMotivation" class="w-full bg-gradient-to-r from-pastel-coral to-pastel-pink text-primary-800 text-xs py-1 px-2 rounded-lg font-medium">
                                    🎯 동기부여 필요
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 참여율 분석 -->
                    <div class="bg-gradient-to-r from-pastel-yellow to-pastel-orange p-4 rounded-xl">
                        <h4 class="text-sm font-bold text-primary-800 mb-3">📊 실시간 참여율 분석</h4>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-white/50 p-2 rounded-lg text-center">
                                <div class="font-bold text-primary-800" id="attendanceRate">0%</div>
                                <div class="text-primary-600">전체 참여율</div>
                            </div>
                            <div class="bg-white/50 p-2 rounded-lg text-center">
                                <div class="font-bold text-primary-800" id="workoutRate">0%</div>
                                <div class="text-primary-600">운동 참여율</div>
                            </div>
                            <div class="bg-white/50 p-2 rounded-lg text-center">
                                <div class="font-bold text-primary-800" id="meetingRate">0%</div>
                                <div class="text-primary-600">벙 참여율</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 멤버 목록 -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-bold text-primary-800">👥 멤버 목록</h4>
                        <div class="text-xs text-primary-600">
                            <span id="workoutCount">0</span>명 운동 | <span id="meetingCount">0</span>명 벙<br>
                            <span id="workoutVoteCount">0</span>명 운동투표 | <span id="meetingVoteCount">0</span>명 벙투표
                        </div>
                    </div>
                </div>
                
                <div id="activityMemberList" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2">
                    <!-- 멤버별 체크박스가 여기에 동적으로 생성됩니다 -->
                </div>
                
                <div class="flex justify-between items-center pt-4 border-t border-white/20">
                    <div class="text-xs text-primary-600">
                        💡 팁: 지난주 참여자를 기준으로 자동선택할 수 있어요
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" id="cancelActivity" class="px-6 py-3 text-primary-600 hover:text-primary-800 font-medium transition-colors rounded-xl hover:bg-pastel-purple">
                            취소
                        </button>
                        <button type="button" id="resetActivity" class="bg-gradient-to-r from-orange-400 to-red-400 text-white px-6 py-3 rounded-xl font-medium hover:from-orange-500 hover:to-red-500 transition-all">
                            🗑️ 초기화
                        </button>
                        <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                            💾 저장
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 비밀번호 변경 모달 -->
    <div id="changePasswordModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-gradient-to-br from-pastel-coral to-pastel-pink rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <span class="text-xl">🔐</span>
                </div>
                <h3 class="text-2xl font-bold text-primary-800">비밀번호 변경</h3>
                <p class="text-primary-600 text-sm mt-2">보안을 위해 현재 비밀번호를 먼저 확인합니다</p>
            </div>
            
            <form id="changePasswordForm" class="space-y-6">
                <!-- 현재 비밀번호 -->
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">현재 비밀번호</label>
                    <div class="relative">
                        <input type="password" id="currentPassword" required 
                               class="input-field w-full px-4 py-3 pr-12 rounded-xl focus:outline-none"
                               placeholder="현재 비밀번호를 입력하세요">
                        <button type="button" id="toggleCurrentPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-primary-500 hover:text-primary-700">
                            👁️
                        </button>
                    </div>
                </div>

                <!-- 새 비밀번호 -->
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">새 비밀번호</label>
                    <div class="relative">
                        <input type="password" id="newPassword" required 
                               class="input-field w-full px-4 py-3 pr-12 rounded-xl focus:outline-none"
                               placeholder="새 비밀번호를 입력하세요" minlength="4">
                        <button type="button" id="toggleNewPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-primary-500 hover:text-primary-700">
                            👁️
                        </button>
                    </div>
                    <div class="mt-1 text-xs text-primary-500">최소 4자 이상 입력해주세요</div>
                </div>

                <!-- 새 비밀번호 확인 -->
                <div>
                    <label class="block text-sm font-semibold text-primary-700 mb-2">새 비밀번호 확인</label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" required 
                               class="input-field w-full px-4 py-3 pr-12 rounded-xl focus:outline-none"
                               placeholder="새 비밀번호를 다시 입력하세요">
                        <button type="button" id="toggleConfirmPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-primary-500 hover:text-primary-700">
                            👁️
                        </button>
                    </div>
                </div>

                <!-- 비밀번호 강도 표시 -->
                <div class="bg-pastel-blue p-3 rounded-xl">
                    <div class="text-xs font-medium text-primary-700 mb-2">비밀번호 강도</div>
                    <div class="flex space-x-1">
                        <div id="strength1" class="flex-1 h-2 bg-gray-200 rounded"></div>
                        <div id="strength2" class="flex-1 h-2 bg-gray-200 rounded"></div>
                        <div id="strength3" class="flex-1 h-2 bg-gray-200 rounded"></div>
                        <div id="strength4" class="flex-1 h-2 bg-gray-200 rounded"></div>
                    </div>
                    <div id="strengthText" class="text-xs text-primary-600 mt-1">비밀번호를 입력하세요</div>
                </div>

                <!-- 에러 메시지 -->
                <div id="passwordChangeError" class="text-red-500 text-sm text-center hidden"></div>

                <!-- 버튼들 -->
                <div class="flex space-x-3 pt-4">
                    <button type="button" id="cancelPasswordChange" class="flex-1 px-6 py-3 text-primary-600 hover:text-primary-800 font-medium transition-colors rounded-xl hover:bg-pastel-purple">
                        취소
                    </button>
                    <button type="submit" class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium">
                        🔐 변경하기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 데이터 내보내기 모달 -->
    <div id="exportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-gradient-to-br from-pastel-green to-pastel-mint rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <span class="text-xl">📁</span>
                </div>
                <h3 class="text-2xl font-bold text-primary-800">데이터 내보내기</h3>
                <p class="text-primary-600 text-sm mt-2">필요한 데이터를 선택해서 내보내세요</p>
            </div>
            
            <div class="space-y-4">
                <!-- Excel 내보내기 -->
                <div class="bg-gradient-to-r from-pastel-blue to-pastel-purple p-4 rounded-xl">
                    <h4 class="font-bold text-primary-800 mb-3 flex items-center">
                        <span class="text-lg mr-2">📊</span>
                        Excel 파일 내보내기
                    </h4>
                    <div class="space-y-2">
                        <button id="exportMembersExcel" class="w-full bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm font-medium hover:bg-white/80 transition-all">
                            👥 멤버 목록 (Excel)
                        </button>
                        <button id="exportActivitiesExcel" class="w-full bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm font-medium hover:bg-white/80 transition-all">
                            📝 활동 기록 (Excel)
                        </button>
                        <button id="exportAllExcel" class="w-full bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm font-medium hover:bg-white/80 transition-all">
                            📋 전체 데이터 (Excel)
                        </button>
                    </div>
                </div>

                <!-- JSON 백업 -->
                <div class="bg-gradient-to-r from-pastel-yellow to-pastel-peach p-4 rounded-xl">
                    <h4 class="font-bold text-primary-800 mb-3 flex items-center">
                        <span class="text-lg mr-2">💾</span>
                        백업 & 복원
                    </h4>
                    <div class="space-y-2">
                        <button id="exportBackup" class="w-full bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm font-medium hover:bg-white/80 transition-all">
                            📦 전체 백업 (JSON)
                        </button>
                        <div class="relative">
                            <input type="file" id="importBackup" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm font-medium hover:bg-white/80 transition-all">
                                📥 백업 복원하기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 월간 리포트 -->
                <div class="bg-gradient-to-r from-pastel-coral to-pastel-pink p-4 rounded-xl">
                    <h4 class="font-bold text-primary-800 mb-3 flex items-center">
                        <span class="text-lg mr-2">📄</span>
                        월간 리포트
                    </h4>
                    <div class="flex space-x-2">
                        <select id="reportMonth" class="flex-1 bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm">
                            <!-- 월 옵션들이 동적으로 생성됩니다 -->
                        </select>
                        <button id="exportMonthlyReport" class="bg-white/60 backdrop-blur-sm text-primary-800 py-2 px-3 rounded-lg text-sm font-medium hover:bg-white/80 transition-all">
                            📄 생성
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mt-8">
                <button id="closeExport" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">
                    ✅ 닫기
                </button>
            </div>
        </div>
    </div>

    <!-- 리포트 모달 -->
    <div id="reportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-4xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-gradient-to-br from-soft-purple to-soft-pink rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <span class="text-xl">📊</span>
                </div>
                <h3 class="text-2xl font-bold text-primary-800">활동 리포트</h3>
                <p class="text-primary-600 text-sm mt-2">멤버들의 활동 현황을 확인하세요</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-pastel-yellow to-pastel-peach p-6 rounded-2xl">
                    <div class="flex items-center space-x-3 mb-4">
                        <span class="text-2xl">⚠️</span>
                        <h4 class="font-bold text-primary-800 text-lg">주간 리포트</h4>
                    </div>
                    <p class="text-primary-700 text-sm mb-3 font-medium">지난주 운동 규칙 미준수자</p>
                    <div id="weeklyReport" class="bg-white/50 backdrop-blur-sm rounded-xl p-4 text-sm">
                        <!-- 주간 리포트 내용 -->
                    </div>
                </div>
                <div class="bg-gradient-to-br from-pastel-coral to-pastel-pink p-6 rounded-2xl">
                    <div class="flex items-center space-x-3 mb-4">
                        <span class="text-2xl">🚨</span>
                        <h4 class="font-bold text-primary-800 text-lg">월간 리포트</h4>
                    </div>
                    <p class="text-primary-700 text-sm mb-3 font-medium">지난달 벙 규칙 미준수자</p>
                    <div id="monthlyReport" class="bg-white/50 backdrop-blur-sm rounded-xl p-4 text-sm">
                        <!-- 월간 리포트 내용 -->
                    </div>
                </div>
            </div>
            <div class="flex justify-center mt-8">
                <button id="closeReport" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">
                    ✅ 확인
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCfJyGLYkyrUZmh_Hm_JheQfiuYa7ebzqc",
            authDomain: "gym-manager-app-b4e95.firebaseapp.com",
            projectId: "gym-manager-app-b4e95",
            storageBucket: "gym-manager-app-b4e95.appspot.com",
            messagingSenderId: "156759434691",
            appId: "1:156759434691:web:86080f103811be3bca8976",
            measurementId: "G-V1MQ4SM85V"
        };

        // Firebase 초기화 (안전한 초기화)
        let db = null;
        try {
            if (firebaseConfig.apiKey !== "your-api-key") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase 연결 성공');
            } else {
                console.log('Firebase 설정이 기본값입니다. 로컬 모드로 실행됩니다.');
            }
        } catch (error) {
            console.log('Firebase 초기화 실패, 로컬 모드로 실행:', error);
        }

        // 전역 변수
        let currentUser = null;
        let currentDate = new Date();
        let currentWeekDate = new Date();
        let currentReportMonth = new Date();
        let members = [];
        let activities = {};
        let editingMemberId = null;

        // DOM 요소
        const loginScreen = document.getElementById('loginScreen');
        const mainDashboard = document.getElementById('mainDashboard');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const userInfo = document.getElementById('userInfo');
        const logoutBtn = document.getElementById('logoutBtn');

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // Firebase 초기화 플래그 리셋 (새로운 멤버 데이터 저장을 위해)
            localStorage.removeItem('firebaseInitialized');
            
            // 로컬 스토리지에서 로그인 정보 확인
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            } else {
                showLogin();
            }
        }

        function setupEventListeners() {
            // 로그인 폼
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);

            // 달력 네비게이션
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // 주간 대시보드 네비게이션
            document.getElementById('prevWeek').addEventListener('click', () => {
                currentWeekDate.setDate(currentWeekDate.getDate() - 7);
                renderWeeklyDashboard();
            });
            document.getElementById('nextWeek').addEventListener('click', () => {
                currentWeekDate.setDate(currentWeekDate.getDate() + 7);
                renderWeeklyDashboard();
            });

            // 월간 리포트 네비게이션
            document.getElementById('prevReportMonth').addEventListener('click', () => {
                currentReportMonth.setMonth(currentReportMonth.getMonth() - 1);
                renderMonthlyReport();
            });
            document.getElementById('nextReportMonth').addEventListener('click', () => {
                currentReportMonth.setMonth(currentReportMonth.getMonth() + 1);
                renderMonthlyReport();
            });

            // 모달 관련
            setupModalEventListeners();

            // 멤버 관리
            document.getElementById('addMemberBtn').addEventListener('click', () => openMemberModal());
            
            // 고급 필터링 이벤트 리스너 (디바운스 적용)
            const debouncedRenderMemberList = debounce(renderMemberList, 300);
            document.getElementById('memberSearch').addEventListener('input', debouncedRenderMemberList);
            document.getElementById('statusFilter').addEventListener('change', renderMemberList);
            document.getElementById('roleFilter').addEventListener('change', renderMemberList);
            document.getElementById('sortFilter').addEventListener('change', renderMemberList);
            document.getElementById('periodFilter').addEventListener('change', renderMemberList);
            
            // 빠른 필터 버튼들
            document.getElementById('filterNewMembers').addEventListener('click', () => applyQuickFilter('new'));
            document.getElementById('filterActiveToday').addEventListener('click', () => applyQuickFilter('today'));
            document.getElementById('filterNeedAttention').addEventListener('click', () => applyQuickFilter('attention'));
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
            
            // 출석 랭킹 기능
            document.getElementById('refreshRanking').addEventListener('click', renderAttendanceRanking);
            document.getElementById('rankingPeriod').addEventListener('change', renderAttendanceRanking);
            
            // 랭킹 탭 기능
            document.getElementById('totalRankingTab').addEventListener('click', () => switchRankingTab('total'));
            document.getElementById('workoutRankingTab').addEventListener('click', () => switchRankingTab('workout'));
            document.getElementById('meetingRankingTab').addEventListener('click', () => switchRankingTab('meeting'));
            
            // 모바일 탭 기능
            setupMobileTabs();
            
            // 터치 제스처 설정
            setupTouchGestures();
            
            // 모바일 메뉴 설정
            setupMobileMenu();
            
            // 성능 최적화 설정
            setupPerformanceOptimizations();

            // 리포트
            document.getElementById('reportBtn').addEventListener('click', openReportModal);
            
            // 비밀번호 변경
            document.getElementById('changePasswordBtn').addEventListener('click', openChangePasswordModal);
            
            // 데이터 내보내기
            document.getElementById('exportBtn').addEventListener('click', openExportModal);
            
            // 강제 초기화 (방장만)
            document.getElementById('forceInitBtn').addEventListener('click', forceFirebaseInit);
        }

        function setupModalEventListeners() {
            // 공지사항 모달
            document.getElementById('editNoticeBtn').addEventListener('click', openNoticeModal);
            document.getElementById('cancelNotice').addEventListener('click', closeNoticeModal);
            document.getElementById('noticeForm').addEventListener('submit', saveNotice);

            // 멤버 모달
            document.getElementById('cancelMember').addEventListener('click', closeMemberModal);
            document.getElementById('deleteMember').addEventListener('click', deleteMemberConfirm);
            document.getElementById('memberForm').addEventListener('submit', saveMember);

            // 활동 모달
            document.getElementById('cancelActivity').addEventListener('click', closeActivityModal);
            document.getElementById('resetActivity').addEventListener('click', resetActivityRecord);
            document.getElementById('activityForm').addEventListener('submit', saveActivity);

            // 리포트 모달
            document.getElementById('closeReport').addEventListener('click', closeReportModal);
            
            // 비밀번호 변경 모달
            document.getElementById('cancelPasswordChange').addEventListener('click', closeChangePasswordModal);
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
            document.getElementById('toggleCurrentPassword').addEventListener('click', () => togglePasswordVisibility('currentPassword'));
            document.getElementById('toggleNewPassword').addEventListener('click', () => togglePasswordVisibility('newPassword'));
            document.getElementById('toggleConfirmPassword').addEventListener('click', () => togglePasswordVisibility('confirmPassword'));
            document.getElementById('newPassword').addEventListener('input', checkPasswordStrength);
            document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

            // 데이터 내보내기 모달
            document.getElementById('closeExport').addEventListener('click', closeExportModal);
            document.getElementById('exportMembersExcel').addEventListener('click', () => exportToExcel('members'));
            document.getElementById('exportActivitiesExcel').addEventListener('click', () => exportToExcel('activities'));
            document.getElementById('exportAllExcel').addEventListener('click', () => exportToExcel('all'));
            document.getElementById('exportBackup').addEventListener('click', exportBackup);
            document.getElementById('importBackup').addEventListener('change', importBackup);
            document.getElementById('exportMonthlyReport').addEventListener('click', exportMonthlyReport);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // 기본 관리자 계정들 (Firebase 연결 전에도 작동)
                const defaultAccounts = {
                    '서아': { password: '1234', name: '서아', role: 'super_admin' },
                    'admin': { password: 'admin123', name: '관리자', role: 'admin' }
                };

                // 기본 계정 확인
                if (defaultAccounts[id] && defaultAccounts[id].password === password) {
                    currentUser = { 
                        id: id, 
                        name: defaultAccounts[id].name, 
                        role: defaultAccounts[id].role 
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Firebase가 연결되어 있다면 모든 멤버 데이터를 Firebase에 저장 (한 번만)
                    try {
                        if (typeof firebase !== 'undefined' && firebase.apps.length > 0 && id === '서아') {
                            // 이미 초기화되었는지 확인
                            const initCheck = localStorage.getItem('firebaseInitialized');
                            if (!initCheck) {
                                console.log('Firebase에 모든 멤버 데이터 저장 중...');
                                
                                // 모든 멤버 데이터 정의
                                const allMembers = [
                                    { id: '서아', name: '서아', nickname: '서아', role: 'super_admin', phone: '010-0000-0000' },
                                    { id: 'member_치즈', name: '치즈', nickname: '치즈', role: 'member', phone: '010-0000-0001' },
                                    { id: 'member_커프', name: '커프', nickname: '커프', role: 'member', phone: '010-0000-0002' },
                                    { id: 'member_하우지', name: '하우지', nickname: '하우지', role: 'member', phone: '010-0000-0003' },
                                    { id: 'member_헬린', name: '헬린', nickname: '헬린', role: 'member', phone: '010-0000-0004' },
                                    { id: 'member_황기적', name: '황기적', nickname: '황기적', role: 'member', phone: '010-0000-0005' },
                                    { id: 'member_블랙', name: '블랙', nickname: '블랙', role: 'member', phone: '010-0000-0006' },
                                    { id: 'member_시원', name: '시원', nickname: '시원', role: 'member', phone: '010-0000-0007' },
                                    { id: 'member_어지', name: '어지', nickname: '어지', role: 'member', phone: '010-0000-0008' },
                                    { id: 'member_줄시작', name: '줄시작', nickname: '줄시작', role: 'member', phone: '010-0000-0009' },
                                    { id: 'member_조폭', name: '조폭', nickname: '조폭', role: 'member', phone: '010-0000-0010' },
                                    { id: 'member_밥밥', name: '밥밥', nickname: '밥밥', role: 'member', phone: '010-0000-0011' },
                                    { id: 'member_뱃살마왕', name: '뱃살마왕', nickname: '뱃살마왕', role: 'member', phone: '010-0000-0012' },
                                    { id: 'member_봉동', name: '봉동', nickname: '봉동', role: 'member', phone: '010-0000-0013' },
                                    { id: 'member_부치', name: '부치', nickname: '부치', role: 'member', phone: '010-0000-0014' },
                                    { id: 'member_구름', name: '구름', nickname: '구름', role: 'member', phone: '010-0000-0015' },
                                    { id: 'member_꿀밤', name: '꿀밤', nickname: '꿀밤', role: 'member', phone: '010-0000-0016' },
                                    { id: 'member_나영', name: '나영', nickname: '나영', role: 'member', phone: '010-0000-0017' },
                                    { id: 'member_무지', name: '무지', nickname: '무지', role: 'member', phone: '010-0000-0018' },
                                    { id: 'member_민영', name: '민영', nickname: '민영', role: 'member', phone: '010-0000-0019' },
                                    { id: 'member_갤럭시', name: '갤럭시', nickname: '갤럭시', role: 'member', phone: '010-0000-0020' },
                                    { id: 'member_거북', name: '거북', nickname: '거북', role: 'member', phone: '010-0000-0021' },
                                    { 
                                        id: 'member_기룬', 
                                        name: '기룬', 
                                        nickname: '기룬', 
                                        role: 'admin', 
                                        phone: '010-0000-0022',
                                        loginId: 'girun',
                                        password: 'ADMIN123',
                                        accountCreated: true,
                                        accountCreatedAt: new Date().toISOString()
                                    },
                                    { id: 'member_오슈', name: '오슈', nickname: '오슈', role: 'member', phone: '010-0000-0023' },
                                    { id: 'member_초보', name: '초보', nickname: '초보', role: 'member', phone: '010-0000-0024' }
                                ];
                                
                                // Firebase에 모든 멤버 저장 (기존 데이터 삭제 후 새로 저장)
                                setTimeout(async () => {
                                    try {
                                        console.log('🗑️ 기존 Firebase 멤버 데이터 삭제 중...');
                                        
                                        // 기존 멤버 데이터 모두 삭제
                                        const existingSnapshot = await db.collection('v2_members').get();
                                        console.log(`삭제할 기존 멤버 수: ${existingSnapshot.size}`);
                                        
                                        const deletePromises = [];
                                        existingSnapshot.forEach(doc => {
                                            deletePromises.push(doc.ref.delete());
                                        });
                                        
                                        if (deletePromises.length > 0) {
                                            await Promise.all(deletePromises);
                                            console.log('✅ 기존 데이터 삭제 완료');
                                        }
                                        
                                        // 1초 대기 후 새 데이터 저장
                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                        
                                        console.log(`📝 Firebase에 ${allMembers.length}명의 멤버 새로 저장 시작...`);
                                        
                                        for (let i = 0; i < allMembers.length; i++) {
                                            const member = allMembers[i];
                                            try {
                                                console.log(`저장 중 ${i + 1}/${allMembers.length}: ${member.name}`);
                                                
                                                await db.collection('v2_members').doc(member.id).set({
                                                    id: member.id,
                                                    name: member.name,
                                                    nickname: member.nickname,
                                                    role: member.role,
                                                    phone: member.phone,
                                                    joinDate: new Date(`2024-01-${String(i + 1).padStart(2, '0')}`).toISOString(),
                                                    isActive: true,
                                                    password: member.role === 'super_admin' ? '1234' : '',
                                                    createdAt: new Date().toISOString(),
                                                    updatedAt: new Date().toISOString()
                                                });
                                                
                                                console.log(`✅ 저장 완료: ${member.name}`);
                                                
                                                // 각 저장 사이에 짧은 지연
                                                await new Promise(resolve => setTimeout(resolve, 100));
                                                
                                            } catch (memberError) {
                                                console.error(`❌ 멤버 ${member.name} 저장 실패:`, memberError);
                                                
                                                // 실패 시 재시도
                                                try {
                                                    console.log(`재시도: ${member.name}`);
                                                    await new Promise(resolve => setTimeout(resolve, 500));
                                                    await db.collection('v2_members').doc(member.id).set({
                                                        id: member.id,
                                                        name: member.name,
                                                        nickname: member.nickname,
                                                        role: member.role,
                                                        phone: member.phone,
                                                        joinDate: new Date(`2024-01-${String(i + 1).padStart(2, '0')}`).toISOString(),
                                                        isActive: true,
                                                        password: member.role === 'super_admin' ? '1234' : '',
                                                        createdAt: new Date().toISOString(),
                                                        updatedAt: new Date().toISOString()
                                                    });
                                                    console.log(`✅ 재시도 성공: ${member.name}`);
                                                } catch (retryError) {
                                                    console.error(`❌ 재시도도 실패: ${member.name}`, retryError);
                                                }
                                            }
                                        }
                                        
                                        localStorage.setItem('firebaseInitialized', 'true');
                                        console.log('🎉 모든 멤버 저장 과정 완료!');
                                        
                                        // 저장 완료 후 확인
                                        setTimeout(async () => {
                                            console.log('Firebase 저장 결과 확인 중...');
                                            const checkSnapshot = await db.collection('v2_members').get();
                                            console.log(`Firebase에 실제 저장된 멤버 수: ${checkSnapshot.size}`);
                                            
                                            // 멤버 목록 새로고침
                                            await loadMembers();
                                            renderMemberList();
                                            console.log('멤버 목록 새로고침 완료');
                                        }, 2000);
                                        
                                    } catch (error) {
                                        console.error('Firebase 저장 전체 오류:', error);
                                    }
                                }, 1000);
                            }
                        }
                    } catch (firebaseError) {
                        console.log('Firebase 저장 실패 (로컬 모드로 계속):', firebaseError);
                    }
                    
                    showDashboard();
                    return;
                }

                // 부방장 계정 확인 (로컬 멤버 목록에서)
                const subAdminMember = members.find(member => 
                    member.loginId === id && 
                    member.password === password && 
                    member.role === 'admin' &&
                    member.accountCreated === true &&
                    member.isActive !== false
                );
                
                if (subAdminMember) {
                    currentUser = {
                        id: subAdminMember.loginId,
                        name: subAdminMember.name,
                        nickname: subAdminMember.nickname,
                        role: 'admin',
                        memberId: subAdminMember.id,
                        password: password,
                        phone: subAdminMember.phone
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMessage(`🎉 ${subAdminMember.name}님, 환영합니다!`, 'success');
                    showDashboard();
                    return;
                }

                // Firebase에서 사용자 확인 (Firebase가 연결된 경우에만)
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    const userDoc = await db.collection('v2_members').doc(id).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.password === password && (userData.role === 'super_admin' || userData.role === 'admin')) {
                            currentUser = { id: id, ...userData };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            showDashboard();
                            return;
                        }
                    }
                    
                    // Firebase에서 loginId로도 검색
                    const memberQuery = await db.collection('v2_members').where('loginId', '==', id).get();
                    if (!memberQuery.empty) {
                        const memberDoc = memberQuery.docs[0];
                        const userData = memberDoc.data();
                        if (userData.password === password && userData.role === 'admin' && userData.accountCreated) {
                            currentUser = {
                                id: userData.loginId,
                                name: userData.name,
                                nickname: userData.nickname,
                                role: 'admin',
                                memberId: memberDoc.id,
                                password: password,
                                phone: userData.phone
                            };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            showMessage(`🎉 ${userData.name}님, 환영합니다!`, 'success');
                            showDashboard();
                            return;
                        }
                    }
                }

                showLoginError('아이디 또는 비밀번호가 올바르지 않습니다.');
            } catch (error) {
                console.error('로그인 오류:', error);
                // Firebase 연결 오류인 경우 기본 계정으로 재시도
                if (error.code === 'unavailable' || error.message.includes('Firebase')) {
                    console.log('Firebase 연결 실패, 로컬 모드로 전환');
                    if (id === '서아' && password === '1234') {
                        currentUser = { id: '서아', name: '서아', role: 'super_admin' };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showDashboard();
                        return;
                    }
                }
                showLoginError('로그인 중 오류가 발생했습니다. 기본 계정(서아/1234)을 사용해보세요.');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 3000);
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLogin();
        }

        function showLogin() {
            loginScreen.classList.remove('hidden');
            mainDashboard.classList.add('hidden');
        }

        function showDashboard() {
            loginScreen.classList.add('hidden');
            mainDashboard.classList.remove('hidden');
            
            // 사용자 정보 표시
            const roleText = currentUser.role === 'super_admin' ? '방장' : '부방장';
            userInfo.textContent = `${currentUser.name} (${roleText})`;
            
            // 방장만 공지수정 버튼과 강제 초기화 버튼 표시
            if (currentUser.role === 'super_admin') {
                document.getElementById('editNoticeBtn').classList.remove('hidden');
                document.getElementById('forceInitBtn').classList.remove('hidden');
            }

            // 데이터 로드
            loadData();
        }

        async function loadData() {
            try {
                await Promise.all([
                    loadMembers(),
                    loadNotice(),
                    loadActivities()
                ]);
                
                renderCalendar();
                renderMemberList();
                renderWeeklyDashboard();
                renderMonthlyReport();
                renderAttendanceRanking(); // 출석 랭킹 추가
            } catch (error) {
                console.error('데이터 로드 오류:', error);
            }
        }

        async function loadMembers() {
            try {
                if (db) {
                    console.log('Firebase에서 멤버 데이터 로드 중...');
                    const snapshot = await db.collection('v2_members').get();
                    members = [];
                    snapshot.forEach(doc => {
                        members.push({ id: doc.id, ...doc.data() });
                        console.log('Firebase에서 로드된 멤버:', doc.id, doc.data().name);
                    });
                    console.log('Firebase에서 총 로드된 멤버 수:', members.length);
                } else {
                    // 로컬 모드: 기본 멤버 데이터 (항상 새로 로드)
                    // const savedMembers = localStorage.getItem('localMembers');
                    // if (savedMembers) {
                    //     members = JSON.parse(savedMembers);
                    // } else {
                        members = [
                            {
                                id: '서아',
                                name: '서아',
                                nickname: '서아',
                                role: 'super_admin',
                                phone: '010-0000-0000',
                                joinDate: new Date().toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_치즈',
                                name: '치즈',
                                nickname: '치즈',
                                role: 'member',
                                phone: '010-0000-0001',
                                joinDate: new Date('2024-01-01').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_커프',
                                name: '커프',
                                nickname: '커프',
                                role: 'member',
                                phone: '010-0000-0002',
                                joinDate: new Date('2024-01-02').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_하우지',
                                name: '하우지',
                                nickname: '하우지',
                                role: 'member',
                                phone: '010-0000-0003',
                                joinDate: new Date('2024-01-03').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_헬린',
                                name: '헬린',
                                nickname: '헬린',
                                role: 'member',
                                phone: '010-0000-0004',
                                joinDate: new Date('2024-01-04').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_황기적',
                                name: '황기적',
                                nickname: '황기적',
                                role: 'member',
                                phone: '010-0000-0005',
                                joinDate: new Date('2024-01-05').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_블랙',
                                name: '블랙',
                                nickname: '블랙',
                                role: 'member',
                                phone: '010-0000-0006',
                                joinDate: new Date('2024-01-06').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_시원',
                                name: '시원',
                                nickname: '시원',
                                role: 'member',
                                phone: '010-0000-0007',
                                joinDate: new Date('2024-01-07').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_어지',
                                name: '어지',
                                nickname: '어지',
                                role: 'member',
                                phone: '010-0000-0008',
                                joinDate: new Date('2024-01-08').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_줄시작',
                                name: '줄시작',
                                nickname: '줄시작',
                                role: 'member',
                                phone: '010-0000-0009',
                                joinDate: new Date('2024-01-09').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_조폭',
                                name: '조폭',
                                nickname: '조폭',
                                role: 'member',
                                phone: '010-0000-0010',
                                joinDate: new Date('2024-01-10').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_밥밥',
                                name: '밥밥',
                                nickname: '밥밥',
                                role: 'member',
                                phone: '010-0000-0011',
                                joinDate: new Date('2024-01-11').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_뱃살마왕',
                                name: '뱃살마왕',
                                nickname: '뱃살마왕',
                                role: 'member',
                                phone: '010-0000-0012',
                                joinDate: new Date('2024-01-12').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_봉동',
                                name: '봉동',
                                nickname: '봉동',
                                role: 'member',
                                phone: '010-0000-0013',
                                joinDate: new Date('2024-01-13').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_부치',
                                name: '부치',
                                nickname: '부치',
                                role: 'member',
                                phone: '010-0000-0014',
                                joinDate: new Date('2024-01-14').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_구름',
                                name: '구름',
                                nickname: '구름',
                                role: 'member',
                                phone: '010-0000-0015',
                                joinDate: new Date('2024-01-15').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_꿀밤',
                                name: '꿀밤',
                                nickname: '꿀밤',
                                role: 'member',
                                phone: '010-0000-0016',
                                joinDate: new Date('2024-01-16').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_나영',
                                name: '나영',
                                nickname: '나영',
                                role: 'member',
                                phone: '010-0000-0017',
                                joinDate: new Date('2024-01-17').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_무지',
                                name: '무지',
                                nickname: '무지',
                                role: 'member',
                                phone: '010-0000-0018',
                                joinDate: new Date('2024-01-18').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_민영',
                                name: '민영',
                                nickname: '민영',
                                role: 'member',
                                phone: '010-0000-0019',
                                joinDate: new Date('2024-01-19').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_갤럭시',
                                name: '갤럭시',
                                nickname: '갤럭시',
                                role: 'member',
                                phone: '010-0000-0020',
                                joinDate: new Date('2024-01-20').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_거북',
                                name: '거북',
                                nickname: '거북',
                                role: 'member',
                                phone: '010-0000-0021',
                                joinDate: new Date('2024-01-21').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_기룬',
                                name: '기룬',
                                nickname: '기룬',
                                role: 'admin',
                                phone: '010-0000-0022',
                                joinDate: new Date('2024-01-22').toISOString(),
                                isActive: true
                            },
                            {
                                id: 'member_오슈',
                                name: '오슈',
                                nickname: '오슈',
                                role: 'member',
                                phone: '010-0000-0023',
                                joinDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // 5일 전 가입
                                isActive: true
                            },
                            {
                                id: 'member_초보',
                                name: '초보',
                                nickname: '초보',
                                role: 'member',
                                phone: '010-0000-0024',
                                joinDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2일 전 가입
                                isActive: true
                            }
                        ];
                        localStorage.setItem('localMembers', JSON.stringify(members));
                    // }
                }
            } catch (error) {
                console.error('멤버 로드 오류:', error);
                members = [];
            }
        }

        async function loadNotice() {
            try {
                if (db) {
                    const doc = await db.collection('v2_config').doc('notice').get();
                    if (doc.exists) {
                        const noticeData = doc.data();
                        updateNoticeDisplay(noticeData.category, noticeData.content);
                    }
                } else {
                    // 로컬 모드: 기본 공지사항
                    const savedNotice = localStorage.getItem('localNotice');
                    if (savedNotice) {
                        const noticeData = JSON.parse(savedNotice);
                        updateNoticeDisplay(noticeData.category, noticeData.content);
                    }
                }
            } catch (error) {
                console.error('공지사항 로드 오류:', error);
            }
        }

        async function loadActivities() {
            try {
                if (db) {
                    const snapshot = await db.collection('v2_activities').get();
                    activities = {};
                    snapshot.forEach(doc => {
                        activities[doc.id] = doc.data();
                    });
                } else {
                    // 로컬 모드: 로컬 스토리지에서 활동 기록 로드
                    const savedActivities = localStorage.getItem('localActivities');
                    if (savedActivities) {
                        activities = JSON.parse(savedActivities);
                    } else {
                        activities = {};
                    }
                }
            } catch (error) {
                console.error('활동 기록 로드 오류:', error);
                activities = {};
            }
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthYear.textContent = `${year}년 ${month + 1}월`;
            
            // 달력 초기화
            calendar.innerHTML = '';
            
            // 요일 헤더
            const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-medium text-gray-600 py-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // 달력 날짜
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day border border-gray-200 p-2 text-center';
                
                const dateStr = formatDate(date);
                const isCurrentMonth = date.getMonth() === month;
                const hasActivity = activities[dateStr];
                
                if (!isCurrentMonth) {
                    dayElement.classList.add('text-gray-400');
                }
                
                if (hasActivity) {
                    dayElement.classList.add('has-activity');
                }
                
                dayElement.innerHTML = `
                    <div class="font-medium">${date.getDate()}</div>
                    ${hasActivity ? '<div class="text-xs text-blue-600 mt-1">활동</div>' : ''}
                `;
                
                dayElement.addEventListener('click', () => openActivityModal(dateStr));
                calendar.appendChild(dayElement);
            }
        }

        function renderMemberList() {
            console.log('renderMemberList 호출됨');
            console.log('members 배열:', members);
            console.log('members 길이:', members.length);
            
            const memberList = document.getElementById('memberList');
            if (!memberList) {
                console.error('memberList 요소를 찾을 수 없습니다!');
                return;
            }
            
            let filteredMembers = [...members];
            
            // 고급 필터링 적용
            filteredMembers = applyAdvancedFilters(filteredMembers);
            
            console.log('필터링된 멤버 수:', filteredMembers.length);
            
            memberList.innerHTML = '';
            
            if (filteredMembers.length === 0) {
                memberList.innerHTML = '<div class="text-gray-500 text-center py-4">멤버가 없습니다.</div>';
                return;
            }
            
            filteredMembers.forEach((member, index) => {
                console.log(`멤버 ${index + 1}:`, member.nickname || member.name);
                
                const memberElement = document.createElement('div');
                const status = getMemberStatus(member);
                const statusText = getStatusText(status);
                const roleIcon = getRoleIcon(member.role);
                const isNew = isNewMember(member);
                
                memberElement.className = `card-gradient p-4 rounded-xl cursor-pointer hover:shadow-soft transition-all duration-300 hover:scale-[1.02] ${member.isActive === false ? 'opacity-60' : ''}`;
                
                const newMemberText = getNewMemberText(member);
                
                memberElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-lg">${roleIcon}</span>
                                <span class="font-semibold text-primary-800">${member.nickname || member.name}</span>
                                ${newMemberText ? `<span class="bg-gradient-to-r from-pastel-mint to-pastel-green text-primary-700 text-xs px-2 py-1 rounded-lg font-medium">${newMemberText}</span>` : ''}
                            </div>
                            <div class="text-sm text-primary-600 font-medium">${member.name}</div>
                            <div class="text-xs text-primary-500">${member.phone || '연락처 없음'}</div>
                        </div>
                        <div class="status-tag status-${status} ml-2">${statusText}</div>
                    </div>
                `;
                
                memberElement.addEventListener('click', () => openMemberModal(member));
                memberList.appendChild(memberElement);
            });
            
            // 필터 결과 업데이트
            updateFilterResults(members.length, filteredMembers.length);
            
            console.log('멤버 목록 렌더링 완료');
        }

        // 고급 필터링 적용 함수
        function applyAdvancedFilters(membersList) {
            let filtered = [...membersList];
            
            // 검색 필터
            const searchTerm = document.getElementById('memberSearch')?.value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(member => 
                    (member.name && member.name.toLowerCase().includes(searchTerm)) ||
                    (member.nickname && member.nickname.toLowerCase().includes(searchTerm))
                );
            }
            
            // 상태 필터
            const statusFilter = document.getElementById('statusFilter')?.value;
            if (statusFilter && statusFilter !== 'all') {
                filtered = filtered.filter(member => getMemberStatus(member) === statusFilter);
            }
            
            // 역할 필터
            const roleFilter = document.getElementById('roleFilter')?.value;
            if (roleFilter && roleFilter !== 'all') {
                filtered = filtered.filter(member => member.role === roleFilter);
            }
            
            // 기간 필터 (활동 기반)
            const periodFilter = document.getElementById('periodFilter')?.value;
            if (periodFilter && periodFilter !== 'all') {
                filtered = applyPeriodFilter(filtered, periodFilter);
            }
            
            // 정렬 적용
            const sortFilter = document.getElementById('sortFilter')?.value;
            if (sortFilter && sortFilter !== 'default') {
                filtered = applySorting(filtered, sortFilter);
            }
            
            return filtered;
        }

        // 기간 필터 적용
        function applyPeriodFilter(membersList, period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'thisWeek':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'lastWeek':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay() - 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'lastMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                default:
                    return membersList;
            }
            
            return membersList.filter(member => {
                const activityCount = countMemberActivity(member.id, startDate, endDate, 'workout') + 
                                   countMemberActivity(member.id, startDate, endDate, 'meeting');
                return activityCount > 0;
            });
        }

        // 정렬 적용
        function applySorting(membersList, sortType) {
            const sorted = [...membersList];
            
            switch (sortType) {
                case 'name':
                    return sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                case 'joinDate':
                    return sorted.sort((a, b) => {
                        const dateA = a.joinDate ? new Date(a.joinDate) : new Date(0);
                        const dateB = b.joinDate ? new Date(b.joinDate) : new Date(0);
                        return dateB - dateA; // 최신순
                    });
                case 'activity':
                    return sorted.sort((a, b) => {
                        const activityA = countMemberActivity(a.id, new Date(2024, 0, 1), new Date(), 'workout') + 
                                        countMemberActivity(a.id, new Date(2024, 0, 1), new Date(), 'meeting');
                        const activityB = countMemberActivity(b.id, new Date(2024, 0, 1), new Date(), 'workout') + 
                                        countMemberActivity(b.id, new Date(2024, 0, 1), new Date(), 'meeting');
                        return activityB - activityA; // 활동 많은 순
                    });
                case 'status':
                    const statusOrder = { 'removal': 0, 'monthly-warning': 1, 'weekly-warning': 2, 'active': 3, 'inactive': 4 };
                    return sorted.sort((a, b) => {
                        const statusA = getMemberStatus(a);
                        const statusB = getMemberStatus(b);
                        return statusOrder[statusA] - statusOrder[statusB];
                    });
                default:
                    return sorted;
            }
        }

        // 빠른 필터 적용
        function applyQuickFilter(type) {
            // 모든 필터 초기화
            clearAllFilters();
            
            switch (type) {
                case 'new':
                    // 신규 멤버만 표시
                    document.getElementById('memberSearch').value = '';
                    // 가입일 기준으로 정렬하고 신규 멤버 필터링은 렌더링에서 처리
                    document.getElementById('sortFilter').value = 'joinDate';
                    break;
                case 'today':
                    // 오늘 활동한 멤버만 표시
                    const today = formatDate(new Date());
                    const todayActivity = activities[today];
                    if (todayActivity) {
                        const activeIds = [...(todayActivity.workout || []), ...(todayActivity.meeting || [])];
                        // 검색으로 필터링 (임시 방법)
                        document.getElementById('periodFilter').value = 'thisWeek';
                    }
                    break;
                case 'attention':
                    // 주의가 필요한 멤버 (경고/강퇴 대상)
                    document.getElementById('statusFilter').value = 'weekly-warning';
                    break;
            }
            
            renderMemberList();
        }

        // 모든 필터 초기화
        function clearAllFilters() {
            document.getElementById('memberSearch').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('roleFilter').value = 'all';
            document.getElementById('sortFilter').value = 'default';
            document.getElementById('periodFilter').value = 'all';
            renderMemberList();
        }

        // 필터 결과 업데이트
        function updateFilterResults(total, filtered) {
            document.getElementById('totalMembers').textContent = total;
            document.getElementById('filteredMembers').textContent = filtered;
        }

        // 현재 선택된 랭킹 타입
        let currentRankingType = 'total';
        
        // 랭킹 탭 전환
        function switchRankingTab(type) {
            currentRankingType = type;
            
            // 탭 스타일 업데이트
            document.querySelectorAll('.ranking-tab, .ranking-tab-active').forEach(tab => {
                tab.className = 'ranking-tab flex-1 text-xs py-2 px-3 rounded-lg font-medium bg-white/30 text-primary-600 hover:bg-white/50';
            });
            
            const activeTab = type === 'total' ? 'totalRankingTab' : 
                             type === 'workout' ? 'workoutRankingTab' : 'meetingRankingTab';
            
            document.getElementById(activeTab).className = 'ranking-tab-active flex-1 text-xs py-2 px-3 rounded-lg font-medium bg-gradient-to-r from-pastel-blue to-pastel-mint text-primary-800';
            
            // 랭킹 다시 렌더링
            renderAttendanceRanking();
        }

        // 출석 랭킹 렌더링 (새로운 기능)
        function renderAttendanceRanking() {
            const rankingContainer = document.getElementById('attendanceRanking');
            const period = document.getElementById('rankingPeriod')?.value || 'week';
            
            if (!rankingContainer) return;
            
            const rankings = calculateAttendanceRanking(period, currentRankingType);
            
            rankingContainer.innerHTML = '';
            
            if (rankings.length === 0) {
                rankingContainer.innerHTML = `
                    <div class="text-center py-4 text-primary-500 text-xs">
                        📊 아직 활동 데이터가 없습니다
                    </div>
                `;
                return;
            }
            
            rankings.forEach((member, index) => {
                const rankElement = document.createElement('div');
                const isTop3 = index < 3;
                const medalEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}`;
                
                rankElement.className = `${isTop3 ? 'bg-gradient-to-r from-pastel-yellow to-pastel-peach' : 'bg-white/30'} p-2 rounded-lg transition-all hover:shadow-soft`;
                
                // 랭킹 타입에 따른 정보 표시
                let detailInfo = '';
                let mainStat = '';
                let subStat = '';
                
                if (currentRankingType === 'total') {
                    detailInfo = `운동 ${member.workoutCount}회 | 벙 ${member.meetingCount}회`;
                    mainStat = `${member.totalActivities}회`;
                    subStat = `${member.rate}%`;
                } else if (currentRankingType === 'workout') {
                    detailInfo = `총 운동 참여`;
                    mainStat = `${member.workoutCount}회`;
                    subStat = `${member.workoutRate || 0}%`;
                } else if (currentRankingType === 'meeting') {
                    detailInfo = `총 벙 참여`;
                    mainStat = `${member.meetingCount}회`;
                    subStat = `${member.meetingRate || 0}%`;
                }
                
                rankElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-bold ${isTop3 ? 'text-primary-800' : 'text-primary-600'}">${medalEmoji}</span>
                            <div>
                                <div class="text-xs font-semibold text-primary-800">${member.name}</div>
                                <div class="text-xs text-primary-600">
                                    ${detailInfo}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-primary-800">${mainStat}</div>
                            <div class="text-xs text-primary-600">${subStat}</div>
                        </div>
                    </div>
                `;
                
                // 클릭 시 해당 멤버 정보 표시
                rankElement.addEventListener('click', () => {
                    const memberData = members.find(m => m.id === member.id);
                    if (memberData) {
                        openMemberModal(memberData);
                    }
                });
                
                rankingContainer.appendChild(rankElement);
            });
        }

        // 출석 랭킹 계산
        function calculateAttendanceRanking(period, rankingType = 'total') {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    endDate = new Date(now);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now);
                    break;
                case 'all':
                default:
                    startDate = new Date(2024, 0, 1); // 2024년 1월 1일부터
                    endDate = new Date(now);
                    break;
            }
            
            const rankings = members
                .filter(member => member.isActive !== false)
                .map(member => {
                    const workoutCount = countMemberActivity(member.id, startDate, endDate, 'workout');
                    const meetingCount = countMemberActivity(member.id, startDate, endDate, 'meeting');
                    const totalActivities = workoutCount + meetingCount;
                    
                    // 기간별 최대 가능 활동 수 계산
                    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    const maxPossibleActivities = period === 'week' ? 14 : // 주간: 운동 7회 + 벙 7회
                                                 period === 'month' ? daysDiff * 2 : // 월간: 일수 * 2
                                                 daysDiff; // 전체: 일수
                    
                    const rate = maxPossibleActivities > 0 ? 
                                Math.round((totalActivities / maxPossibleActivities) * 100) : 0;
                    
                    // 개별 활동 참여율 계산
                    const workoutRate = possibleDays > 0 ? Math.round((workoutCount / possibleDays) * 100) : 0;
                    const meetingRate = possibleDays > 0 ? Math.round((meetingCount / possibleDays) * 100) : 0;
                    
                    return {
                        id: member.id,
                        name: member.nickname || member.name,
                        workoutCount,
                        meetingCount,
                        totalActivities,
                        rate: Math.min(rate, 100), // 100% 초과 방지
                        workoutRate: Math.min(workoutRate, 100),
                        meetingRate: Math.min(meetingRate, 100)
                    };
                })
                .sort((a, b) => {
                    // 랭킹 타입에 따른 정렬
                    if (rankingType === 'workout') {
                        // 운동 랭킹: 운동 횟수로 정렬
                        if (b.workoutCount !== a.workoutCount) {
                            return b.workoutCount - a.workoutCount;
                        }
                        return b.workoutRate - a.workoutRate;
                    } else if (rankingType === 'meeting') {
                        // 벙 랭킹: 벙 횟수로 정렬
                        if (b.meetingCount !== a.meetingCount) {
                            return b.meetingCount - a.meetingCount;
                        }
                        return b.meetingRate - a.meetingRate;
                    } else {
                        // 종합 랭킹: 총 활동 수로 1차 정렬, 참여율로 2차 정렬
                        if (b.totalActivities !== a.totalActivities) {
                            return b.totalActivities - a.totalActivities;
                        }
                        return b.rate - a.rate;
                    }
                })
                .slice(0, 10); // 상위 10명만
            
            return rankings;
        }

        // 모바일 탭 기능 설정
        function setupMobileTabs() {
            const tabMain = document.getElementById('tabMain');
            const tabMembers = document.getElementById('tabMembers');
            const mainContent = document.getElementById('mainContent');
            const memberContent = document.getElementById('memberContent');
            
            if (!tabMain || !tabMembers || !mainContent || !memberContent) return;
            
            // 초기 상태 설정
            showMainTab();
            
            tabMain.addEventListener('click', showMainTab);
            tabMembers.addEventListener('click', showMembersTab);
            
            function showMainTab() {
                // 탭 스타일 변경
                tabMain.classList.add('tab-active');
                tabMain.classList.remove('text-primary-600');
                tabMembers.classList.remove('tab-active');
                tabMembers.classList.add('text-primary-600');
                
                // 콘텐츠 표시/숨김
                if (window.innerWidth < 1024) {
                    mainContent.classList.remove('hidden');
                    mainContent.classList.add('block');
                    memberContent.classList.add('hidden');
                    memberContent.classList.remove('block');
                }
            }
            
            function showMembersTab() {
                // 탭 스타일 변경
                tabMembers.classList.add('tab-active');
                tabMembers.classList.remove('text-primary-600');
                tabMain.classList.remove('tab-active');
                tabMain.classList.add('text-primary-600');
                
                // 콘텐츠 표시/숨김
                if (window.innerWidth < 1024) {
                    memberContent.classList.remove('hidden');
                    memberContent.classList.add('block');
                    mainContent.classList.add('hidden');
                    mainContent.classList.remove('block');
                }
            }
            
            // 화면 크기 변경 시 대응
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    // 데스크톱에서는 모든 콘텐츠 표시
                    mainContent.classList.remove('hidden');
                    mainContent.classList.add('block');
                    memberContent.classList.remove('hidden');
                    memberContent.classList.add('block');
                } else {
                    // 모바일에서는 현재 활성 탭만 표시
                    if (tabMain.classList.contains('tab-active')) {
                        showMainTab();
                    } else {
                        showMembersTab();
                    }
                }
            });
        }

        // 터치 제스처 지원 (스와이프)
        function setupTouchGestures() {
            let startX = 0;
            let startY = 0;
            
            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                if (!startX || !startY) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                
                const diffX = startX - endX;
                const diffY = startY - endY;
                
                // 수평 스와이프가 수직 스와이프보다 클 때만 처리
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (window.innerWidth < 1024) { // 모바일에서만
                        if (diffX > 0) {
                            // 왼쪽으로 스와이프 - 멤버 탭으로
                            document.getElementById('tabMembers')?.click();
                        } else {
                            // 오른쪽으로 스와이프 - 메인 탭으로
                            document.getElementById('tabMain')?.click();
                        }
                    }
                }
                
                startX = 0;
                startY = 0;
            });
        }

        // 모바일 메뉴 설정
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (!mobileMenuBtn || !mobileMenu) return;
            
            // 모바일 메뉴 토글
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // 모바일 버튼들을 데스크톱 버튼들과 연결
            document.getElementById('changePasswordBtnMobile')?.addEventListener('click', () => {
                document.getElementById('changePasswordBtn')?.click();
                mobileMenu.classList.add('hidden');
            });
            
            document.getElementById('exportBtnMobile')?.addEventListener('click', () => {
                document.getElementById('exportBtn')?.click();
                mobileMenu.classList.add('hidden');
            });
            
            document.getElementById('reportBtnMobile')?.addEventListener('click', () => {
                document.getElementById('reportBtn')?.click();
                mobileMenu.classList.add('hidden');
            });
            
            document.getElementById('logoutBtnMobile')?.addEventListener('click', () => {
                document.getElementById('logoutBtn')?.click();
                mobileMenu.classList.add('hidden');
            });
            
            // 외부 클릭 시 메뉴 닫기
            document.addEventListener('click', (e) => {
                if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }

        function getMemberStatus(member) {
            if (member.isActive === false) return 'inactive';
            
            const now = new Date();
            
            // 현재 주의 시작일과 종료일 계산 (일요일 시작)
            const startOfWeek = new Date(now);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day;
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            // 현재 월의 시작일과 종료일 계산
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // 지난주 계산 (현재 주가 금요일 이후인 경우 체크)
            const lastWeekStart = new Date(startOfWeek);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekEnd = new Date(endOfWeek);
            lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);
            
            // 지난달 계산
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            
            // 멤버의 활동 카운트 계산
            const currentWeekWorkouts = countMemberActivity(member.id, startOfWeek, endOfWeek, 'workout');
            const currentMonthMeetings = countMemberActivity(member.id, startOfMonth, endOfMonth, 'meeting');
            const lastWeekWorkouts = countMemberActivity(member.id, lastWeekStart, lastWeekEnd, 'workout');
            const lastMonthMeetings = countMemberActivity(member.id, lastMonth, lastMonthEnd, 'meeting');
            
            // 상태 결정 로직
            const today = now.getDay(); // 0: 일요일, 5: 금요일
            const isAfterFriday = today >= 5; // 금요일 이후
            const isAfter25th = now.getDate() >= 25; // 25일 이후
            
            // 🔴 강퇴대상: 지난주 운동 규칙 또는 지난달 벙 규칙 최종 미달
            if (lastWeekWorkouts < 2 || lastMonthMeetings < 1) {
                return 'removal';
            }
            
            // 🟠 월간경고: 해당 월 25일 이후 월간 벙 1회 미달 시
            if (isAfter25th && currentMonthMeetings < 1) {
                return 'monthly-warning';
            }
            
            // 🟡 주간경고: 해당 주 금요일 이후 주간 운동 2회 미달 시
            if (isAfterFriday && currentWeekWorkouts < 2) {
                return 'weekly-warning';
            }
            
            // 🟢 활동중: 모든 규칙 준수
            return 'active';
        }
        
        // 멤버의 특정 기간 활동 카운트 계산 함수
        function countMemberActivity(memberId, startDate, endDate, activityType) {
            let count = 0;
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dayActivity = activities[dateStr];
                
                if (dayActivity && dayActivity[activityType] && dayActivity[activityType].includes(memberId)) {
                    count++;
                }
            }
            
            return count;
        }

        function getStatusText(status) {
            const statusMap = {
                'active': '🟢 활동중',
                'weekly-warning': '🟡 주간경고',
                'monthly-warning': '🟠 월간경고',
                'removal': '🔴 강퇴대상',
                'inactive': '⚫ 비활성'
            };
            return statusMap[status] || '🟢 활동중';
        }

        function getRoleIcon(role) {
            switch (role) {
                case 'super_admin': return '👑';
                case 'admin': return '⭐';
                default: return '';
            }
        }

        function isNewMember(member) {
            if (!member.joinDate) return false;
            
            // 첫 벙 참여 여부 확인
            const hasFirstMeeting = hasParticipatedInMeeting(member.id);
            if (hasFirstMeeting) return false;
            
            // 가입일로부터 30일 이내인지 확인
            const joinDate = new Date(member.joinDate);
            const now = new Date();
            const diffTime = Math.abs(now - joinDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 30;
        }
        
        // 멤버가 벙에 참여한 적이 있는지 확인
        function hasParticipatedInMeeting(memberId) {
            for (const dateStr in activities) {
                const dayActivity = activities[dateStr];
                if (dayActivity && dayActivity.meeting && dayActivity.meeting.includes(memberId)) {
                    return true;
                }
            }
            return false;
        }
        
        // 신규 멤버 표시 텍스트 생성
        function getNewMemberText(member) {
            if (!isNewMember(member)) return '';
            
            const joinDate = new Date(member.joinDate);
            const formattedDate = `${joinDate.getMonth() + 1}/${joinDate.getDate()}`;
            return `🌱 신규 (${formattedDate})`;
        }

        // 모달 관련 함수들
        function openNoticeModal() {
            document.getElementById('noticeModal').classList.add('active');
        }

        function closeNoticeModal() {
            document.getElementById('noticeModal').classList.remove('active');
        }

        async function saveNotice(e) {
            e.preventDefault();
            const category = document.getElementById('noticeCategory').value;
            const content = document.getElementById('noticeText').value;
            
            try {
                const noticeData = {
                    category: category,
                    content: content,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.id
                };
                
                if (db) {
                    await db.collection('v2_config').doc('notice').set(noticeData);
                } else {
                    // 로컬 모드: 로컬 스토리지에 저장
                    localStorage.setItem('localNotice', JSON.stringify(noticeData));
                }
                
                updateNoticeDisplay(category, content);
                closeNoticeModal();
            } catch (error) {
                console.error('공지사항 저장 오류:', error);
                alert('공지사항 저장 중 오류가 발생했습니다.');
            }
        }

        function updateNoticeDisplay(category, content) {
            const noticeContent = document.getElementById('noticeContent');
            noticeContent.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <span class="font-medium">[${category}]</span> ${content}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function openMemberModal(member = null) {
            const modal = document.getElementById('memberModal');
            const title = document.getElementById('memberModalTitle');
            const deleteBtn = document.getElementById('deleteMember');
            
            if (member) {
                title.textContent = '멤버 수정';
                document.getElementById('memberNickname').value = member.nickname || '';
                document.getElementById('memberName').value = member.name || '';
                document.getElementById('memberPhone').value = member.phone || '';
                document.getElementById('memberRole').value = member.role || 'member';
                document.getElementById('memberInactive').checked = member.isActive === false;
                deleteBtn.classList.remove('hidden');
                editingMemberId = member.id;
            } else {
                title.textContent = '멤버 추가';
                document.getElementById('memberForm').reset();
                deleteBtn.classList.add('hidden');
                editingMemberId = null;
            }
            
            modal.classList.add('active');
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('active');
            editingMemberId = null;
        }

        async function saveMember(e) {
            e.preventDefault();
            const nickname = document.getElementById('memberNickname').value;
            const name = document.getElementById('memberName').value;
            const phone = document.getElementById('memberPhone').value;
            const role = document.getElementById('memberRole').value;
            const isActive = !document.getElementById('memberInactive').checked;
            
            // 기존 멤버 정보 가져오기 (역할 변경 감지용)
            const existingMember = editingMemberId ? members.find(m => m.id === editingMemberId) : null;
            const wasAdmin = existingMember && existingMember.role === 'admin';
            const isNowAdmin = role === 'admin';
            
            const memberData = {
                nickname: nickname,
                name: name,
                phone: phone,
                role: role,
                isActive: isActive,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.id
            };
            
            if (!editingMemberId) {
                memberData.joinDate = new Date().toISOString();
            }
            
            // 부방장(admin)으로 설정될 때 계정 정보 추가
            if (isNowAdmin && !wasAdmin) {
                const accountInfo = await createSubAdminAccount(nickname, name);
                memberData.loginId = accountInfo.loginId;
                memberData.password = accountInfo.password;
                memberData.accountCreated = true;
                memberData.accountCreatedAt = new Date().toISOString();
            }
            
            // 부방장에서 일반 멤버로 변경될 때 계정 정보 제거
            if (!isNowAdmin && wasAdmin) {
                memberData.loginId = null;
                memberData.password = null;
                memberData.accountCreated = false;
                memberData.accountRemovedAt = new Date().toISOString();
            }
            
            try {
                const memberId = editingMemberId || `member_${Date.now()}`;
                
                if (db) {
                    await db.collection('v2_members').doc(memberId).set(memberData, { merge: true });
                } else {
                    // 로컬 모드: 로컬 스토리지에 저장
                    const existingIndex = members.findIndex(m => m.id === memberId);
                    if (existingIndex >= 0) {
                        members[existingIndex] = { id: memberId, ...memberData };
                    } else {
                        members.push({ id: memberId, ...memberData });
                    }
                    localStorage.setItem('localMembers', JSON.stringify(members));
                }
                
                // 계정 생성/삭제 알림
                if (isNowAdmin && !wasAdmin) {
                    showAccountCreatedNotification(memberData.loginId, memberData.password, name);
                } else if (!isNowAdmin && wasAdmin) {
                    showMessage(`${name}님의 부방장 계정이 삭제되었습니다.`, 'info');
                }
                
                await loadMembers();
                renderMemberList();
                closeMemberModal();
            } catch (error) {
                console.error('멤버 저장 오류:', error);
                alert('멤버 저장 중 오류가 발생했습니다.');
            }
        }

        async function deleteMemberConfirm() {
            if (!editingMemberId) return;
            
            if (confirm('정말로 이 멤버를 삭제하시겠습니까?')) {
                try {
                    if (db) {
                        await db.collection('v2_members').doc(editingMemberId).delete();
                    } else {
                        // 로컬 모드: 배열에서 제거
                        members = members.filter(m => m.id !== editingMemberId);
                        localStorage.setItem('localMembers', JSON.stringify(members));
                    }
                    await loadMembers();
                    renderMemberList();
                    closeMemberModal();
                } catch (error) {
                    console.error('멤버 삭제 오류:', error);
                    alert('멤버 삭제 중 오류가 발생했습니다.');
                }
            }
        }

        function openActivityModal(dateStr) {
            const modal = document.getElementById('activityModal');
            const title = document.getElementById('activityModalTitle');
            const memberList = document.getElementById('activityMemberList');
            
            title.textContent = `${dateStr} 활동 기록`;
            
            memberList.innerHTML = '';
            const activeMembers = members.filter(m => m.isActive !== false);
            
            activeMembers.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'card-gradient p-4 rounded-xl border border-white/20';
                
                const currentActivity = activities[dateStr] || {};
                const hasWorkout = currentActivity.workout && currentActivity.workout.includes(member.id);
                const hasMeeting = currentActivity.meeting && currentActivity.meeting.includes(member.id);
                const hasWorkoutVote = currentActivity.workoutVote && currentActivity.workoutVote.includes(member.id);
                const hasMeetingVote = currentActivity.meetingVote && currentActivity.meetingVote.includes(member.id);
                
                const roleIcon = getRoleIcon(member.role);
                
                memberDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${roleIcon}</span>
                                <span class="font-semibold text-primary-800">${member.nickname || member.name}</span>
                            </div>
                        </div>
                        
                        <!-- 활동 참여 -->
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="text-xs font-bold text-primary-700 mb-2">✅ 활동 참여</div>
                            <div class="flex space-x-3">
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="checkbox" name="workout" value="${member.id}" ${hasWorkout ? 'checked' : ''} class="w-3 h-3 text-primary-600 rounded workout-checkbox">
                                    <span class="text-xs font-medium text-primary-700 bg-pastel-blue px-2 py-1 rounded">💪 운동</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="checkbox" name="meeting" value="${member.id}" ${hasMeeting ? 'checked' : ''} class="w-3 h-3 text-primary-600 rounded meeting-checkbox">
                                    <span class="text-xs font-medium text-primary-700 bg-pastel-green px-2 py-1 rounded">🍻 벙</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 투표 참여 -->
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="text-xs font-bold text-primary-700 mb-2">🗳️ 투표 참여</div>
                            <div class="flex space-x-3">
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="checkbox" name="workoutVote" value="${member.id}" ${hasWorkoutVote ? 'checked' : ''} class="w-3 h-3 text-purple-600 rounded workout-vote-checkbox">
                                    <span class="text-xs font-medium text-primary-700 bg-pastel-purple px-2 py-1 rounded">🗳️ 운동투표</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="checkbox" name="meetingVote" value="${member.id}" ${hasMeetingVote ? 'checked' : ''} class="w-3 h-3 text-purple-600 rounded meeting-vote-checkbox">
                                    <span class="text-xs font-medium text-primary-700 bg-pastel-coral px-2 py-1 rounded">🗳️ 벙투표</span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                memberList.appendChild(memberDiv);
            });
            
            // 빠른 액션 버튼 이벤트 리스너 추가
            setupQuickActionButtons();
            
            // 체크박스 변경 시 카운트 업데이트
            setupCheckboxListeners();
            
            // 날짜 입력 필드 초기화
            document.getElementById('activityDate').value = dateStr;
            
            // 초기 카운트 및 참여율 업데이트
            updateActivityCounts();
            updateAttendanceRates();
            
            modal.dataset.date = dateStr;
            modal.classList.add('active');
        }
        
        // 빠른 액션 버튼 설정 (확장)
        function setupQuickActionButtons() {
            // 기존 기본 기능들
            document.getElementById('selectAllWorkout').onclick = () => {
                document.querySelectorAll('.workout-checkbox').forEach(cb => {
                    cb.checked = true;
                });
                updateActivityCounts();
                updateAttendanceRates();
            };
            
            document.getElementById('clearAllWorkout').onclick = () => {
                document.querySelectorAll('.workout-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                updateActivityCounts();
                updateAttendanceRates();
            };
            
            document.getElementById('selectAllMeeting').onclick = () => {
                document.querySelectorAll('.meeting-checkbox').forEach(cb => {
                    cb.checked = true;
                });
                updateActivityCounts();
                updateAttendanceRates();
            };
            
            document.getElementById('clearAllMeeting').onclick = () => {
                document.querySelectorAll('.meeting-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                updateActivityCounts();
                updateAttendanceRates();
            };
            
            document.getElementById('autoSelectLastWeek').onclick = () => {
                autoSelectLastWeekParticipants();
            };

            // 새로운 고급 기능들
            document.getElementById('selectHighAttendance').onclick = () => {
                selectByAttendanceRate('high');
            };
            
            document.getElementById('selectNeedMotivation').onclick = () => {
                selectByAttendanceRate('low');
            };
            
            document.getElementById('copyToWeek').onclick = () => {
                copyToWeekSchedule();
            };
            
            document.getElementById('scheduleReminder').onclick = () => {
                scheduleAttendanceReminder();
            };

            // 날짜 변경 시 처리
            document.getElementById('activityDate').onchange = (e) => {
                updateModalForDate(e.target.value);
            };
        }
        
        // 체크박스 리스너 설정
        function setupCheckboxListeners() {
            document.querySelectorAll('.workout-checkbox, .meeting-checkbox, .workout-vote-checkbox, .meeting-vote-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateActivityCounts();
                    updateAttendanceRates();
                });
            });
        }
        
        // 활동 카운트 업데이트
        function updateActivityCounts() {
            const workoutCount = document.querySelectorAll('.workout-checkbox:checked').length;
            const meetingCount = document.querySelectorAll('.meeting-checkbox:checked').length;
            const workoutVoteCount = document.querySelectorAll('.workout-vote-checkbox:checked').length;
            const meetingVoteCount = document.querySelectorAll('.meeting-vote-checkbox:checked').length;
            
            document.getElementById('workoutCount').textContent = workoutCount;
            document.getElementById('meetingCount').textContent = meetingCount;
            document.getElementById('workoutVoteCount').textContent = workoutVoteCount;
            document.getElementById('meetingVoteCount').textContent = meetingVoteCount;
        }

        // 참여율 업데이트 (새로운 기능)
        function updateAttendanceRates() {
            const totalMembers = document.querySelectorAll('.workout-checkbox').length;
            const workoutCount = document.querySelectorAll('.workout-checkbox:checked').length;
            const meetingCount = document.querySelectorAll('.meeting-checkbox:checked').length;
            const totalParticipants = new Set([
                ...Array.from(document.querySelectorAll('.workout-checkbox:checked')).map(cb => cb.value),
                ...Array.from(document.querySelectorAll('.meeting-checkbox:checked')).map(cb => cb.value)
            ]).size;
            
            if (totalMembers > 0) {
                const attendanceRate = Math.round((totalParticipants / totalMembers) * 100);
                const workoutRate = Math.round((workoutCount / totalMembers) * 100);
                const meetingRate = Math.round((meetingCount / totalMembers) * 100);
                
                document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
                document.getElementById('workoutRate').textContent = `${workoutRate}%`;
                document.getElementById('meetingRate').textContent = `${meetingRate}%`;
            }
        }

        // 참여율 기준 선택 (새로운 기능)
        function selectByAttendanceRate(type) {
            const memberAttendanceRates = calculateMemberAttendanceRates();
            
            if (type === 'high') {
                // 참여율 상위 70% 멤버들 선택
                const highAttendanceMembers = memberAttendanceRates
                    .filter(m => m.rate >= 70)
                    .map(m => m.id);
                
                selectMembersByIds(highAttendanceMembers);
                showMessage('🏆 고참여자들이 선택되었습니다!', 'success');
            } else {
                // 참여율 하위 50% 멤버들 선택 (동기부여 필요)
                const lowAttendanceMembers = memberAttendanceRates
                    .filter(m => m.rate < 50)
                    .map(m => m.id);
                
                selectMembersByIds(lowAttendanceMembers);
                showMessage('🎯 동기부여가 필요한 멤버들이 선택되었습니다!', 'warning');
            }
        }

        // 멤버별 참여율 계산
        function calculateMemberAttendanceRates() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            return members.filter(m => m.isActive !== false).map(member => {
                const workoutCount = countMemberActivity(member.id, thirtyDaysAgo, now, 'workout');
                const meetingCount = countMemberActivity(member.id, thirtyDaysAgo, now, 'meeting');
                const totalActivities = workoutCount + meetingCount;
                const maxPossibleActivities = 30; // 30일간 최대 가능 활동
                const rate = Math.round((totalActivities / maxPossibleActivities) * 100);
                
                return {
                    id: member.id,
                    name: member.nickname || member.name,
                    rate: rate,
                    workoutCount,
                    meetingCount
                };
            }).sort((a, b) => b.rate - a.rate);
        }

        // ID 기준 멤버 선택
        function selectMembersByIds(memberIds) {
            // 모든 체크박스 해제
            document.querySelectorAll('.workout-checkbox, .meeting-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // 선택된 멤버들만 체크
            memberIds.forEach(memberId => {
                const workoutCheckbox = document.querySelector(`.workout-checkbox[value="${memberId}"]`);
                const meetingCheckbox = document.querySelector(`.meeting-checkbox[value="${memberId}"]`);
                
                if (workoutCheckbox) workoutCheckbox.checked = true;
                if (meetingCheckbox) meetingCheckbox.checked = true;
            });
            
            updateActivityCounts();
            updateAttendanceRates();
        }

        // 이번주 전체 복사 (새로운 기능)
        function copyToWeekSchedule() {
            const modal = document.getElementById('activityModal');
            const currentDateStr = modal.dataset.date;
            const currentDate = new Date(currentDateStr);
            
            // 현재 선택된 멤버들 가져오기
            const selectedWorkout = Array.from(document.querySelectorAll('.workout-checkbox:checked')).map(cb => cb.value);
            const selectedMeeting = Array.from(document.querySelectorAll('.meeting-checkbox:checked')).map(cb => cb.value);
            
            if (selectedWorkout.length === 0 && selectedMeeting.length === 0) {
                showMessage('❌ 먼저 복사할 멤버들을 선택해주세요!', 'error');
                return;
            }
            
            if (confirm('이번주 전체에 현재 선택을 복사하시겠습니까?')) {
                const promises = [];
                
                // 이번주 7일간 복사
                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(currentDate);
                    targetDate.setDate(currentDate.getDate() - currentDate.getDay() + i);
                    const targetDateStr = formatDate(targetDate);
                    
                    const activityData = {
                        date: targetDateStr,
                        workout: selectedWorkout,
                        meeting: selectedMeeting,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.id,
                        copiedFrom: currentDateStr
                    };
                    
                    activities[targetDateStr] = activityData;
                    
                    if (db) {
                        promises.push(db.collection('v2_activities').doc(targetDateStr).set(activityData));
                    }
                }
                
                Promise.all(promises).then(() => {
                    renderCalendar();
                    renderWeeklyDashboard();
                    renderMonthlyReport();
                    showMessage('📅 이번주 전체에 복사가 완료되었습니다!', 'success');
                }).catch(error => {
                    console.error('복사 오류:', error);
                    showMessage('❌ 복사 중 오류가 발생했습니다.', 'error');
                });
                
                // 로컬 스토리지 업데이트
                localStorage.setItem('localActivities', JSON.stringify(activities));
            }
        }

        // 알림 예약 (새로운 기능)
        function scheduleAttendanceReminder() {
            const modal = document.getElementById('activityModal');
            const currentDateStr = modal.dataset.date;
            
            // 미달자 찾기
            const underperformers = findUnderperformers();
            
            if (underperformers.length === 0) {
                showMessage('🎉 모든 멤버가 목표를 달성했습니다!', 'success');
                return;
            }
            
            // 알림 메시지 생성
            const reminderMessage = `📢 운동 참여 알림\n\n다음 멤버들의 참여가 필요합니다:\n${underperformers.map(m => `• ${m.name} (${m.reason})`).join('\n')}\n\n날짜: ${currentDateStr}`;
            
            // 브라우저 알림 권한 요청
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        // 1시간 후 알림 예약 (실제로는 서버 필요, 여기서는 시연용)
                        setTimeout(() => {
                            new Notification('운동 방 관리 시스템', {
                                body: `${underperformers.length}명의 멤버가 참여가 필요합니다.`,
                                icon: '💪'
                            });
                        }, 5000); // 5초 후 시연
                        
                        showMessage('🔔 알림이 예약되었습니다! (5초 후 시연)', 'success');
                    }
                });
            }
            
            // 콘솔에도 출력
            console.log('예약된 알림:', reminderMessage);
        }

        // 미달자 찾기
        function findUnderperformers() {
            const now = new Date();
            const thisWeekStart = new Date(now);
            thisWeekStart.setDate(now.getDate() - now.getDay());
            
            return members.filter(member => {
                if (member.isActive === false) return false;
                
                const workoutCount = countMemberActivity(member.id, thisWeekStart, now, 'workout');
                const meetingCount = countMemberActivity(member.id, new Date(now.getFullYear(), now.getMonth(), 1), now, 'meeting');
                
                const reasons = [];
                if (workoutCount < 2) reasons.push('주간 운동 미달');
                if (meetingCount < 1) reasons.push('월간 벙 미달');
                
                if (reasons.length > 0) {
                    return {
                        id: member.id,
                        name: member.nickname || member.name,
                        reason: reasons.join(', ')
                    };
                }
                return false;
            }).filter(Boolean);
        }

        // 날짜 변경 시 모달 업데이트
        function updateModalForDate(dateStr) {
            const modal = document.getElementById('activityModal');
            modal.dataset.date = dateStr;
            
            // 제목 업데이트
            document.getElementById('activityModalTitle').textContent = `${dateStr} 활동 기록`;
            
            // 기존 데이터 로드
            const existingActivity = activities[dateStr] || {};
            
            // 체크박스 상태 업데이트
            document.querySelectorAll('.workout-checkbox').forEach(cb => {
                cb.checked = existingActivity.workout && existingActivity.workout.includes(cb.value);
            });
            
            document.querySelectorAll('.meeting-checkbox').forEach(cb => {
                cb.checked = existingActivity.meeting && existingActivity.meeting.includes(cb.value);
            });
            
            updateActivityCounts();
            updateAttendanceRates();
        }

        // 메시지 표시 유틸리티
        function showMessage(message, type = 'info') {
            // 간단한 토스트 메시지 (실제로는 더 예쁜 UI 구현 가능)
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-xl shadow-soft-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'warning' ? 'bg-yellow-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white font-medium`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // 지난주 참여자 자동 선택
        function autoSelectLastWeekParticipants() {
            const modal = document.getElementById('activityModal');
            const currentDateStr = modal.dataset.date;
            const currentDate = new Date(currentDateStr);
            
            // 지난주 같은 요일 계산
            const lastWeekDate = new Date(currentDate);
            lastWeekDate.setDate(lastWeekDate.getDate() - 7);
            const lastWeekDateStr = formatDate(lastWeekDate);
            
            const lastWeekActivity = activities[lastWeekDateStr];
            
            if (lastWeekActivity) {
                // 운동 참여자 선택
                if (lastWeekActivity.workout) {
                    lastWeekActivity.workout.forEach(memberId => {
                        const checkbox = document.querySelector(`.workout-checkbox[value="${memberId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // 벙 참여자 선택
                if (lastWeekActivity.meeting) {
                    lastWeekActivity.meeting.forEach(memberId => {
                        const checkbox = document.querySelector(`.meeting-checkbox[value="${memberId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                updateActivityCounts();
                
                // 성공 메시지
                const button = document.getElementById('autoSelectLastWeek');
                const originalText = button.textContent;
                button.textContent = '✅ 적용완료!';
                button.style.background = 'linear-gradient(to right, #10b981, #059669)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            } else {
                // 데이터 없음 메시지
                const button = document.getElementById('autoSelectLastWeek');
                const originalText = button.textContent;
                button.textContent = '❌ 지난주 데이터 없음';
                button.style.background = 'linear-gradient(to right, #f87171, #ef4444)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
        }

        // 활동 기록 초기화
        function resetActivityRecord() {
            const modal = document.getElementById('activityModal');
            const dateStr = modal.dataset.date;
            
            if (!dateStr) return;
            
            if (confirm('⚠️ 이 날짜의 모든 활동 기록을 삭제하시겠습니까?\n\n삭제된 데이터는 복구할 수 없습니다.')) {
                try {
                    // 해당 날짜의 활동 데이터 삭제
                    if (activities[dateStr]) {
                        delete activities[dateStr];
                    }
                    
                    // Firebase에서 삭제 (연결된 경우)
                    if (db) {
                        db.collection('v2_activities').doc(dateStr).delete()
                            .then(() => {
                                console.log('Firebase에서 활동 기록 삭제 완료:', dateStr);
                            })
                            .catch(error => {
                                console.error('Firebase 삭제 오류:', error);
                            });
                    }
                    
                    // 로컬 스토리지 업데이트
                    localStorage.setItem('localActivities', JSON.stringify(activities));
                    
                    // 화면 업데이트
                    renderCalendar();
                    renderWeeklyDashboard();
                    renderMonthlyReport();
                    renderMemberList(); // 멤버 상태 업데이트
                    renderAttendanceRanking(); // 랭킹 업데이트
                    
                    // 모달 내 체크박스 모두 해제
                    const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // 참여율 업데이트
                    updateAttendanceRates();
                    
                    showMessage(`🗑️ ${dateStr} 활동 기록이 삭제되었습니다.`, 'success');
                    
                } catch (error) {
                    console.error('활동 기록 삭제 오류:', error);
                    showMessage('❌ 삭제 중 오류가 발생했습니다.', 'error');
                }
            }
        }

        async function saveActivity(e) {
            e.preventDefault();
            const modal = document.getElementById('activityModal');
            const dateStr = modal.dataset.date;
            
            const workoutCheckboxes = modal.querySelectorAll('input[name="workout"]:checked');
            const meetingCheckboxes = modal.querySelectorAll('input[name="meeting"]:checked');
            const workoutVoteCheckboxes = modal.querySelectorAll('input[name="workoutVote"]:checked');
            const meetingVoteCheckboxes = modal.querySelectorAll('input[name="meetingVote"]:checked');
            
            const workoutMembers = Array.from(workoutCheckboxes).map(cb => cb.value);
            const meetingMembers = Array.from(meetingCheckboxes).map(cb => cb.value);
            const workoutVoteMembers = Array.from(workoutVoteCheckboxes).map(cb => cb.value);
            const meetingVoteMembers = Array.from(meetingVoteCheckboxes).map(cb => cb.value);
            
            const activityData = {
                date: dateStr,
                workout: workoutMembers,
                meeting: meetingMembers,
                workoutVote: workoutVoteMembers,
                meetingVote: meetingVoteMembers,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.id
            };
            
            try {
                if (db) {
                    await db.collection('v2_activities').doc(dateStr).set(activityData);
                } else {
                    // 로컬 모드: 로컬 스토리지에 저장
                    localStorage.setItem('localActivities', JSON.stringify({...activities, [dateStr]: activityData}));
                }
                activities[dateStr] = activityData;
                renderCalendar();
                renderWeeklyDashboard();
                renderMonthlyReport();
                renderMemberList(); // 멤버 상태 업데이트를 위해 목록 다시 렌더링
                closeActivityModal();
            } catch (error) {
                console.error('활동 기록 저장 오류:', error);
                alert('활동 기록 저장 중 오류가 발생했습니다.');
            }
        }

        function openReportModal() {
            const modal = document.getElementById('reportModal');
            generateReports();
            modal.classList.add('active');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function generateReports() {
            // 주간 리포트 생성 (예시)
            const weeklyReport = document.getElementById('weeklyReport');
            weeklyReport.innerHTML = '<p class="text-gray-600">지난주 운동 규칙 미준수자가 없습니다.</p>';
            
            // 월간 리포트 생성 (예시)
            const monthlyReport = document.getElementById('monthlyReport');
            monthlyReport.innerHTML = '<p class="text-gray-600">지난달 벙 규칙 미준수자가 없습니다.</p>';
        }

        // 주간 대시보드 렌더링
        function renderWeeklyDashboard() {
            const currentWeekElement = document.getElementById('currentWeek');
            const weeklyWorkoutCount = document.getElementById('weeklyWorkoutCount');
            const weeklyMeetingCount = document.getElementById('weeklyMeetingCount');
            const weeklyUnderperformers = document.getElementById('weeklyUnderperformers');
            
            // 현재 주의 시작일과 종료일 계산 (월요일 시작)
            const startOfWeek = new Date(currentWeekDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // 월요일을 주의 시작으로
            startOfWeek.setDate(diff);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // 주간 표시 업데이트
            const startStr = `${startOfWeek.getMonth() + 1}/${startOfWeek.getDate()}`;
            const endStr = `${endOfWeek.getMonth() + 1}/${endOfWeek.getDate()}`;
            currentWeekElement.textContent = `${startStr} - ${endStr}`;
            
            // 해당 주의 활동 데이터 수집
            let totalWorkouts = 0;
            let totalMeetings = 0;
            const memberWorkoutCounts = {};
            const memberMeetingCounts = {};
            
            // 멤버별 카운트 초기화
            members.forEach(member => {
                if (member.isActive !== false) {
                    memberWorkoutCounts[member.id] = 0;
                    memberMeetingCounts[member.id] = 0;
                }
            });
            
            // 해당 주의 각 날짜 확인
            for (let d = new Date(startOfWeek); d <= endOfWeek; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dayActivity = activities[dateStr];
                
                if (dayActivity) {
                    if (dayActivity.workout) {
                        totalWorkouts += dayActivity.workout.length;
                        dayActivity.workout.forEach(memberId => {
                            if (memberWorkoutCounts[memberId] !== undefined) {
                                memberWorkoutCounts[memberId]++;
                            }
                        });
                    }
                    if (dayActivity.meeting) {
                        totalMeetings += dayActivity.meeting.length;
                        dayActivity.meeting.forEach(memberId => {
                            if (memberMeetingCounts[memberId] !== undefined) {
                                memberMeetingCounts[memberId]++;
                            }
                        });
                    }
                }
            }
            
            // 통계 업데이트
            weeklyWorkoutCount.textContent = `${totalWorkouts}회`;
            weeklyMeetingCount.textContent = `${totalMeetings}회`;
            
            // 주간 운동 미달자 (2회 미만)
            const underperformers = [];
            Object.keys(memberWorkoutCounts).forEach(memberId => {
                if (memberWorkoutCounts[memberId] < 2) {
                    const member = members.find(m => m.id === memberId);
                    if (member) {
                        underperformers.push({
                            name: member.nickname || member.name,
                            count: memberWorkoutCounts[memberId]
                        });
                    }
                }
            });
            
            // 미달자 목록 표시
            weeklyUnderperformers.innerHTML = '';
            if (underperformers.length === 0) {
                weeklyUnderperformers.innerHTML = '<div class="text-center py-6"><div class="text-4xl mb-2">🎉</div><div class="text-sm font-medium text-primary-600">모든 멤버가 목표를 달성했습니다!</div></div>';
            } else {
                underperformers.forEach(member => {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'bg-gradient-to-r from-pastel-yellow to-pastel-peach p-3 rounded-xl mb-2 shadow-sm border border-white/30';
                    memberDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">⚠️</span>
                                <span class="font-semibold text-primary-800">${member.name}</span>
                            </div>
                            <div class="bg-white/60 backdrop-blur-sm px-3 py-1 rounded-lg">
                                <span class="text-sm font-bold text-primary-700">${member.count}회</span>
                            </div>
                        </div>
                    `;
                    weeklyUnderperformers.appendChild(memberDiv);
                });
            }
        }
        
        // 월간 리포트 렌더링
        function renderMonthlyReport() {
            const currentReportMonthElement = document.getElementById('currentReportMonth');
            const monthlyWorkoutCount = document.getElementById('monthlyWorkoutCount');
            const monthlyMeetingCount = document.getElementById('monthlyMeetingCount');
            const monthlyUnderperformers = document.getElementById('monthlyUnderperformers');
            
            // 현재 월 표시 업데이트
            const monthStr = `${currentReportMonth.getFullYear()}년 ${currentReportMonth.getMonth() + 1}월`;
            currentReportMonthElement.textContent = monthStr;
            
            // 해당 월의 첫날과 마지막날
            const startOfMonth = new Date(currentReportMonth.getFullYear(), currentReportMonth.getMonth(), 1);
            const endOfMonth = new Date(currentReportMonth.getFullYear(), currentReportMonth.getMonth() + 1, 0);
            
            // 해당 월의 활동 데이터 수집
            let totalWorkouts = 0;
            let totalMeetings = 0;
            const memberWorkoutCounts = {};
            const memberMeetingCounts = {};
            
            // 멤버별 카운트 초기화
            members.forEach(member => {
                if (member.isActive !== false) {
                    memberWorkoutCounts[member.id] = 0;
                    memberMeetingCounts[member.id] = 0;
                }
            });
            
            // 해당 월의 각 날짜 확인
            for (let d = new Date(startOfMonth); d <= endOfMonth; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dayActivity = activities[dateStr];
                
                if (dayActivity) {
                    if (dayActivity.workout) {
                        totalWorkouts += dayActivity.workout.length;
                        dayActivity.workout.forEach(memberId => {
                            if (memberWorkoutCounts[memberId] !== undefined) {
                                memberWorkoutCounts[memberId]++;
                            }
                        });
                    }
                    if (dayActivity.meeting) {
                        totalMeetings += dayActivity.meeting.length;
                        dayActivity.meeting.forEach(memberId => {
                            if (memberMeetingCounts[memberId] !== undefined) {
                                memberMeetingCounts[memberId]++;
                            }
                        });
                    }
                }
            }
            
            // 통계 업데이트
            monthlyWorkoutCount.textContent = `${totalWorkouts}회`;
            monthlyMeetingCount.textContent = `${totalMeetings}회`;
            
            // 월간 벙 미달자 (1회 미만)
            const underperformers = [];
            Object.keys(memberMeetingCounts).forEach(memberId => {
                if (memberMeetingCounts[memberId] < 1) {
                    const member = members.find(m => m.id === memberId);
                    if (member) {
                        underperformers.push({
                            name: member.nickname || member.name,
                            count: memberMeetingCounts[memberId]
                        });
                    }
                }
            });
            
            // 미달자 목록 표시
            monthlyUnderperformers.innerHTML = '';
            if (underperformers.length === 0) {
                monthlyUnderperformers.innerHTML = '<div class="text-center py-6"><div class="text-4xl mb-2">🎉</div><div class="text-sm font-medium text-primary-600">모든 멤버가 목표를 달성했습니다!</div></div>';
            } else {
                underperformers.forEach(member => {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'bg-gradient-to-r from-pastel-coral to-pastel-pink p-3 rounded-xl mb-2 shadow-sm border border-white/30';
                    memberDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">🚨</span>
                                <span class="font-semibold text-primary-800">${member.name}</span>
                            </div>
                            <div class="bg-white/60 backdrop-blur-sm px-3 py-1 rounded-lg">
                                <span class="text-sm font-bold text-primary-700">${member.count}회</span>
                            </div>
                        </div>
                    `;
                    monthlyUnderperformers.appendChild(memberDiv);
                });
            }
        }

        // 강제 Firebase 초기화 함수
        async function forceFirebaseInit() {
            if (!confirm('Firebase에 모든 멤버 데이터를 강제로 다시 저장하시겠습니까?\n(기존 데이터는 삭제됩니다)')) {
                return;
            }
            
            try {
                console.log('🔄 Firebase 강제 초기화 시작...');
                
                // 초기화 플래그 제거
                localStorage.removeItem('firebaseInitialized');
                
                // 모든 멤버 데이터 정의
                const allMembers = [
                    { id: '서아', name: '서아', nickname: '서아', role: 'super_admin', phone: '010-0000-0000' },
                    { id: 'member_치즈', name: '치즈', nickname: '치즈', role: 'member', phone: '010-0000-0001' },
                    { id: 'member_커프', name: '커프', nickname: '커프', role: 'member', phone: '010-0000-0002' },
                    { id: 'member_하우지', name: '하우지', nickname: '하우지', role: 'member', phone: '010-0000-0003' },
                    { id: 'member_헬린', name: '헬린', nickname: '헬린', role: 'member', phone: '010-0000-0004' },
                    { id: 'member_황기적', name: '황기적', nickname: '황기적', role: 'member', phone: '010-0000-0005' },
                    { id: 'member_블랙', name: '블랙', nickname: '블랙', role: 'member', phone: '010-0000-0006' },
                    { id: 'member_시원', name: '시원', nickname: '시원', role: 'member', phone: '010-0000-0007' },
                    { id: 'member_어지', name: '어지', nickname: '어지', role: 'member', phone: '010-0000-0008' },
                    { id: 'member_줄시작', name: '줄시작', nickname: '줄시작', role: 'member', phone: '010-0000-0009' },
                    { id: 'member_조폭', name: '조폭', nickname: '조폭', role: 'member', phone: '010-0000-0010' },
                    { id: 'member_밥밥', name: '밥밥', nickname: '밥밥', role: 'member', phone: '010-0000-0011' },
                    { id: 'member_뱃살마왕', name: '뱃살마왕', nickname: '뱃살마왕', role: 'member', phone: '010-0000-0012' },
                    { id: 'member_봉동', name: '봉동', nickname: '봉동', role: 'member', phone: '010-0000-0013' },
                    { id: 'member_부치', name: '부치', nickname: '부치', role: 'member', phone: '010-0000-0014' },
                    { id: 'member_구름', name: '구름', nickname: '구름', role: 'member', phone: '010-0000-0015' },
                    { id: 'member_꿀밤', name: '꿀밤', nickname: '꿀밤', role: 'member', phone: '010-0000-0016' },
                    { id: 'member_나영', name: '나영', nickname: '나영', role: 'member', phone: '010-0000-0017' },
                    { id: 'member_무지', name: '무지', nickname: '무지', role: 'member', phone: '010-0000-0018' },
                    { id: 'member_민영', name: '민영', nickname: '민영', role: 'member', phone: '010-0000-0019' },
                    { id: 'member_갤럭시', name: '갤럭시', nickname: '갤럭시', role: 'member', phone: '010-0000-0020' },
                    { id: 'member_거북', name: '거북', nickname: '거북', role: 'member', phone: '010-0000-0021' },
                    { id: 'member_기룬', name: '기룬', nickname: '기룬', role: 'admin', phone: '010-0000-0022' },
                    { id: 'member_오슈', name: '오슈', nickname: '오슈', role: 'member', phone: '010-0000-0023' },
                    { id: 'member_초보', name: '초보', nickname: '초보', role: 'member', phone: '010-0000-0024' }
                ];
                
                // 기존 데이터 삭제
                console.log('🗑️ 기존 데이터 삭제 중...');
                const existingSnapshot = await db.collection('v2_members').get();
                const deletePromises = [];
                existingSnapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                }
                
                // 새 데이터 저장
                console.log('📝 새 데이터 저장 중...');
                for (let i = 0; i < allMembers.length; i++) {
                    const member = allMembers[i];
                    console.log(`저장 중 ${i + 1}/${allMembers.length}: ${member.name}`);
                    
                    await db.collection('v2_members').doc(member.id).set({
                        id: member.id,
                        name: member.name,
                        nickname: member.nickname,
                        role: member.role,
                        phone: member.phone,
                        joinDate: new Date(`2024-01-${String(i + 1).padStart(2, '0')}`).toISOString(),
                        isActive: true,
                        password: member.role === 'super_admin' ? '1234' : '',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                localStorage.setItem('firebaseInitialized', 'true');
                console.log('✅ 강제 초기화 완료!');
                
                // 확인 및 새로고침
                const checkSnapshot = await db.collection('v2_members').get();
                console.log(`Firebase에 저장된 멤버 수: ${checkSnapshot.size}`);
                
                await loadMembers();
                renderMemberList();
                
                alert(`Firebase 초기화 완료!\n저장된 멤버 수: ${checkSnapshot.size}명`);
                
            } catch (error) {
                console.error('강제 초기화 오류:', error);
                alert('초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 성능 최적화 설정
        function setupPerformanceOptimizations() {
            // 지연 로딩 설정
            setupLazyLoading();
            
            // 가상 스크롤링 설정 (멤버 목록이 많을 때)
            if (members.length > 50) {
                setupVirtualScrolling('memberList');
            }
            
            // 주기적 메모리 정리 (5분마다)
            setInterval(cleanupMemory, 300000);
            
            // 페이지 가시성 API 활용
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // 페이지가 숨겨졌을 때 불필요한 작업 중단
                    clearInterval(renderDebounceTimer);
                } else {
                    // 페이지가 다시 보일 때 데이터 새로고침
                    renderMemberList();
                    renderWeeklyDashboard();
                    renderMonthlyReport();
                }
            });
            
            // 네트워크 상태 모니터링
            if ('connection' in navigator) {
                const connection = navigator.connection;
                
                function updateNetworkStatus() {
                    if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                        // 느린 네트워크에서는 업데이트 빈도 줄이기
                        console.log('느린 네트워크 감지: 성능 모드 활성화');
                    }
                }
                
                connection.addEventListener('change', updateNetworkStatus);
                updateNetworkStatus();
            }
            
            // 메모리 사용량 모니터링 (지원되는 브라우저에서만)
            if ('memory' in performance) {
                const checkMemory = () => {
                    const memory = performance.memory;
                    const usedPercent = (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100;
                    
                    if (usedPercent > 80) {
                        console.warn('메모리 사용량이 높습니다:', usedPercent.toFixed(2) + '%');
                        cleanupMemory();
                    }
                };
                
                setInterval(checkMemory, 60000); // 1분마다 체크
            }
            
            // 이미지 최적화 (WebP 지원 체크)
            const supportsWebP = (() => {
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
            })();
            
            if (supportsWebP) {
                console.log('WebP 이미지 형식 지원됨');
            }
        }

        // 성능 최적화 관련 함수들
        let performanceCache = new Map();
        let renderDebounceTimer = null;
        
        // 로딩 상태 관리
        function showLoading(message = '로딩 중...') {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingStatus = document.getElementById('loadingStatus');
            if (loadingScreen && loadingStatus) {
                loadingStatus.textContent = message;
                loadingScreen.classList.remove('hidden');
            }
        }
        
        function hideLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
            }
        }
        
        // 디바운스 함수 (빈번한 호출 방지)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 스로틀 함수 (일정 간격으로만 실행)
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // 캐시 관리
        function getCachedData(key) {
            const cached = performanceCache.get(key);
            if (cached && Date.now() - cached.timestamp < 300000) { // 5분 캐시
                return cached.data;
            }
            return null;
        }
        
        function setCachedData(key, data) {
            performanceCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        }
        
        // 가상 스크롤링 (대용량 리스트 최적화)
        function setupVirtualScrolling(containerId, itemHeight = 80) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let visibleItems = Math.ceil(container.clientHeight / itemHeight) + 2;
            let scrollTop = 0;
            
            const updateVisibleItems = throttle(() => {
                scrollTop = container.scrollTop;
                const startIndex = Math.floor(scrollTop / itemHeight);
                const endIndex = Math.min(startIndex + visibleItems, members.length);
                
                // 실제 렌더링은 보이는 부분만
                renderVisibleMembers(startIndex, endIndex);
            }, 16); // 60fps
            
            container.addEventListener('scroll', updateVisibleItems);
            return updateVisibleItems;
        }
        
        // 보이는 멤버만 렌더링 (성능 최적화)
        function renderVisibleMembers(startIndex, endIndex) {
            const memberList = document.getElementById('memberList');
            if (!memberList) return;
            
            // 캐시된 필터링 결과 사용
            const cacheKey = `filtered_members_${JSON.stringify(getFilterState())}`;
            let filteredMembers = getCachedData(cacheKey);
            
            if (!filteredMembers) {
                filteredMembers = applyAdvancedFilters([...members]);
                setCachedData(cacheKey, filteredMembers);
            }
            
            const visibleMembers = filteredMembers.slice(startIndex, endIndex);
            
            // DOM 조작 최소화
            const fragment = document.createDocumentFragment();
            
            visibleMembers.forEach(member => {
                const memberElement = createMemberElement(member);
                fragment.appendChild(memberElement);
            });
            
            memberList.innerHTML = '';
            memberList.appendChild(fragment);
            
            updateFilterResults(members.length, filteredMembers.length);
        }
        
        // 멤버 엘리먼트 생성 (재사용 가능)
        function createMemberElement(member) {
            const memberElement = document.createElement('div');
            const status = getMemberStatus(member);
            const statusText = getStatusText(status);
            const roleIcon = getRoleIcon(member.role);
            const newMemberText = getNewMemberText(member);
            
            memberElement.className = `card-gradient p-4 rounded-xl cursor-pointer hover:shadow-soft transition-all duration-300 hover:scale-[1.02] ${member.isActive === false ? 'opacity-60' : ''}`;
            
            memberElement.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-lg">${roleIcon}</span>
                            <span class="font-semibold text-primary-800">${member.nickname || member.name}</span>
                            ${newMemberText ? `<span class="bg-gradient-to-r from-pastel-mint to-pastel-green text-primary-700 text-xs px-2 py-1 rounded-lg font-medium">${newMemberText}</span>` : ''}
                        </div>
                        <div class="text-sm text-primary-600 font-medium">${member.name}</div>
                        <div class="text-xs text-primary-500">${member.phone || '연락처 없음'}</div>
                    </div>
                    <div class="status-tag status-${status} ml-2">${statusText}</div>
                </div>
            `;
            
            memberElement.addEventListener('click', () => openMemberModal(member));
            return memberElement;
        }
        
        // 현재 필터 상태 가져오기
        function getFilterState() {
            return {
                search: document.getElementById('memberSearch')?.value || '',
                status: document.getElementById('statusFilter')?.value || 'all',
                role: document.getElementById('roleFilter')?.value || 'all',
                sort: document.getElementById('sortFilter')?.value || 'default',
                period: document.getElementById('periodFilter')?.value || 'all'
            };
        }
        
        // 지연 로딩 (이미지나 무거운 컨텐츠)
        function setupLazyLoading() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        if (element.dataset.src) {
                            element.src = element.dataset.src;
                            element.removeAttribute('data-src');
                        }
                        observer.unobserve(element);
                    }
                });
            });
            
            document.querySelectorAll('[data-src]').forEach(img => {
                observer.observe(img);
            });
        }
        
        // 메모리 정리
        function cleanupMemory() {
            // 오래된 캐시 정리
            const now = Date.now();
            for (const [key, value] of performanceCache.entries()) {
                if (now - value.timestamp > 600000) { // 10분 이상된 캐시 삭제
                    performanceCache.delete(key);
                }
            }
            
            // 이벤트 리스너 정리 (필요시)
            if (window.gc && typeof window.gc === 'function') {
                window.gc(); // 개발 환경에서만 사용 가능
            }
        }
        
        // 성능 모니터링
        function measurePerformance(name, func) {
            const start = performance.now();
            const result = func();
            const end = performance.now();
            console.log(`${name} 실행 시간: ${(end - start).toFixed(2)}ms`);
            return result;
        }

        // 유틸리티 함수들
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 비밀번호 변경 관련 함수들
        function openChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            
            // 폼 초기화
            document.getElementById('changePasswordForm').reset();
            document.getElementById('passwordChangeError').classList.add('hidden');
            resetPasswordStrength();
            
            modal.classList.add('active');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        // 비밀번호 보기/숨기기 토글
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(`toggle${inputId.charAt(0).toUpperCase() + inputId.slice(1)}`);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        // 비밀번호 강도 체크
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBars = [
                document.getElementById('strength1'),
                document.getElementById('strength2'),
                document.getElementById('strength3'),
                document.getElementById('strength4')
            ];
            const strengthText = document.getElementById('strengthText');
            
            // 강도 계산
            let strength = 0;
            if (password.length >= 4) strength++;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password) && /[a-z]/.test(password)) strength++;
            if (/\d/.test(password) && /[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
            
            // 바 색상 업데이트
            strengthBars.forEach((bar, index) => {
                if (index < strength) {
                    const colors = ['bg-red-400', 'bg-yellow-400', 'bg-blue-400', 'bg-green-400'];
                    bar.className = `flex-1 h-2 rounded ${colors[strength - 1]}`;
                } else {
                    bar.className = 'flex-1 h-2 bg-gray-200 rounded';
                }
            });
            
            // 텍스트 업데이트
            const texts = ['매우 약함', '약함', '보통', '강함'];
            strengthText.textContent = password.length === 0 ? '비밀번호를 입력하세요' : texts[strength - 1] || '매우 약함';
            
            // 비밀번호 일치 확인도 다시 체크
            checkPasswordMatch();
        }

        // 비밀번호 일치 확인
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const confirmInput = document.getElementById('confirmPassword');
            
            if (confirmPassword.length === 0) {
                confirmInput.style.borderColor = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                confirmInput.style.borderColor = '#10b981'; // 녹색
            } else {
                confirmInput.style.borderColor = '#ef4444'; // 빨간색
            }
        }

        // 비밀번호 강도 초기화
        function resetPasswordStrength() {
            const strengthBars = [
                document.getElementById('strength1'),
                document.getElementById('strength2'),
                document.getElementById('strength3'),
                document.getElementById('strength4')
            ];
            
            strengthBars.forEach(bar => {
                bar.className = 'flex-1 h-2 bg-gray-200 rounded';
            });
            
            document.getElementById('strengthText').textContent = '비밀번호를 입력하세요';
        }

        // 비밀번호 변경 처리
        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordChangeError');
            
            // 유효성 검사
            if (newPassword !== confirmPassword) {
                showPasswordError('새 비밀번호가 일치하지 않습니다.');
                return;
            }
            
            if (newPassword.length < 4) {
                showPasswordError('새 비밀번호는 최소 4자 이상이어야 합니다.');
                return;
            }
            
            if (currentPassword === newPassword) {
                showPasswordError('새 비밀번호는 현재 비밀번호와 달라야 합니다.');
                return;
            }
            
            try {
                // 현재 비밀번호 확인
                const isCurrentPasswordValid = await verifyCurrentPassword(currentPassword);
                
                if (!isCurrentPasswordValid) {
                    showPasswordError('현재 비밀번호가 올바르지 않습니다.');
                    return;
                }
                
                // 새 비밀번호 저장
                await updatePassword(newPassword);
                
                // 성공 메시지
                showMessage('🔐 비밀번호가 성공적으로 변경되었습니다!', 'success');
                closeChangePasswordModal();
                
                // 자동 로그아웃 (보안상 재로그인 필요)
                setTimeout(() => {
                    if (confirm('보안을 위해 다시 로그인해주세요. 로그아웃하시겠습니까?')) {
                        handleLogout();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('비밀번호 변경 오류:', error);
                showPasswordError('비밀번호 변경 중 오류가 발생했습니다.');
            }
        }

        // 현재 비밀번호 확인
        async function verifyCurrentPassword(password) {
            // 기본 계정 확인
            const defaultAccounts = {
                '서아': '1234',
                'admin': 'admin123'
            };
            
            if (defaultAccounts[currentUser.id] && defaultAccounts[currentUser.id] === password) {
                return true;
            }
            
            // 부방장 계정인 경우 로컬 members 배열에서 확인
            if (currentUser.role === 'admin' && currentUser.loginId) {
                const memberByLoginId = members.find(m => m.loginId === currentUser.loginId);
                if (memberByLoginId && memberByLoginId.password === password) {
                    return true;
                }
            }
            
            // memberId가 있는 경우 (부방장 계정)
            if (currentUser.memberId) {
                const memberById = members.find(m => m.id === currentUser.memberId);
                if (memberById && memberById.password === password) {
                    return true;
                }
            }
            
            // Firebase에서 확인 (연결된 경우)
            if (db) {
                try {
                    let userDoc;
                    
                    // 부방장 계정인 경우 memberId로 확인
                    if (currentUser.memberId) {
                        userDoc = await db.collection('v2_members').doc(currentUser.memberId).get();
                    } else {
                        userDoc = await db.collection('v2_members').doc(currentUser.id).get();
                    }
                    
                    if (userDoc && userDoc.exists) {
                        const userData = userDoc.data();
                        return userData.password === password;
                    }
                } catch (error) {
                    console.error('Firebase 비밀번호 확인 오류:', error);
                }
            }
            
            // 현재 저장된 비밀번호와 비교 (로컬 모드)
            const savedUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (savedUser.password && savedUser.password === password) {
                return true;
            }
            
            return false;
        }

        // 비밀번호 업데이트
        async function updatePassword(newPassword) {
            // 현재 사용자 정보 업데이트
            currentUser.password = newPassword;
            
            // 로컬 스토리지 업데이트
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Firebase 업데이트 (연결된 경우)
            if (db) {
                try {
                    // 부방장 계정인 경우 memberId로 업데이트
                    if (currentUser.memberId) {
                        await db.collection('v2_members').doc(currentUser.memberId).update({
                            password: newPassword,
                            passwordUpdatedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    } else {
                        // 기본 계정인 경우 currentUser.id로 업데이트
                        await db.collection('v2_members').doc(currentUser.id).update({
                            password: newPassword,
                            passwordUpdatedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }
                    console.log('Firebase 비밀번호 업데이트 완료');
                } catch (error) {
                    console.error('Firebase 비밀번호 업데이트 오류:', error);
                    // Firebase 실패해도 로컬은 성공으로 처리
                }
            }
            
            // 로컬 members 배열에서도 업데이트
            let memberToUpdate = null;
            
            // 부방장 계정인 경우 memberId로 찾기
            if (currentUser.memberId) {
                memberToUpdate = members.find(m => m.id === currentUser.memberId);
            } else {
                // 기본 계정인 경우 id로 찾기
                memberToUpdate = members.find(m => m.id === currentUser.id);
            }
            
            if (memberToUpdate) {
                memberToUpdate.password = newPassword;
                memberToUpdate.passwordUpdatedAt = new Date().toISOString();
                memberToUpdate.updatedAt = new Date().toISOString();
                localStorage.setItem('localMembers', JSON.stringify(members));
                console.log('로컬 멤버 배열 비밀번호 업데이트 완료');
            }
            
            // 부방장 계정의 경우 loginId로도 확인
            if (currentUser.role === 'admin' && currentUser.loginId) {
                const memberByLoginId = members.find(m => m.loginId === currentUser.loginId);
                if (memberByLoginId) {
                    memberByLoginId.password = newPassword;
                    memberByLoginId.passwordUpdatedAt = new Date().toISOString();
                    memberByLoginId.updatedAt = new Date().toISOString();
                    localStorage.setItem('localMembers', JSON.stringify(members));
                    console.log('부방장 계정 비밀번호 업데이트 완료');
                }
            }
        }

        // 비밀번호 에러 표시
        function showPasswordError(message) {
            const errorDiv = document.getElementById('passwordChangeError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // 부방장 계정 생성 관련 함수들
        async function createSubAdminAccount(nickname, name) {
            // 로그인 ID 생성 (닉네임 기반, 중복 방지)
            let loginId = nickname.toLowerCase().replace(/\s+/g, '');
            
            // 기존 ID와 중복 확인
            let counter = 1;
            let originalLoginId = loginId;
            while (await isLoginIdExists(loginId)) {
                loginId = `${originalLoginId}${counter}`;
                counter++;
            }
            
            // 기본 비밀번호 생성 (안전한 임시 비밀번호)
            const tempPassword = generateTempPassword();
            
            return {
                loginId: loginId,
                password: tempPassword
            };
        }

        // 로그인 ID 중복 확인
        async function isLoginIdExists(loginId) {
            // 기본 계정 확인
            const defaultAccounts = ['서아', 'admin'];
            if (defaultAccounts.includes(loginId)) {
                return true;
            }
            
            // 기존 멤버들의 loginId 확인
            const existingIds = members
                .filter(m => m.loginId)
                .map(m => m.loginId);
            
            return existingIds.includes(loginId);
        }

        // 임시 비밀번호 생성
        function generateTempPassword() {
            // 안전하면서도 기억하기 쉬운 형태의 임시 비밀번호
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // 계정 생성 알림 모달
        function showAccountCreatedNotification(loginId, password, name) {
            // 커스텀 알림 모달 생성
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="card-gradient rounded-2xl shadow-soft-lg p-8 w-full max-w-md mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-pastel-green to-pastel-mint rounded-xl mx-auto mb-4 flex items-center justify-center">
                            <span class="text-2xl">🎉</span>
                        </div>
                        <h3 class="text-xl font-bold text-primary-800">부방장 계정 생성 완료!</h3>
                        <p class="text-primary-600 text-sm mt-2">${name}님의 로그인 계정이 생성되었습니다</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-pastel-blue to-pastel-purple p-4 rounded-xl mb-6">
                        <h4 class="font-bold text-primary-800 mb-3 text-center">📋 로그인 정보</h4>
                        <div class="space-y-3">
                            <div class="bg-white/50 p-3 rounded-lg">
                                <div class="text-xs text-primary-600 mb-1">아이디</div>
                                <div class="font-bold text-primary-800 flex items-center justify-between">
                                    <span id="newLoginId">${loginId}</span>
                                    <button onclick="copyToClipboard('${loginId}')" class="text-xs bg-pastel-mint px-2 py-1 rounded hover:bg-pastel-green transition-colors">복사</button>
                                </div>
                            </div>
                            <div class="bg-white/50 p-3 rounded-lg">
                                <div class="text-xs text-primary-600 mb-1">임시 비밀번호</div>
                                <div class="font-bold text-primary-800 flex items-center justify-between">
                                    <span id="newPassword">${password}</span>
                                    <button onclick="copyToClipboard('${password}')" class="text-xs bg-pastel-mint px-2 py-1 rounded hover:bg-pastel-green transition-colors">복사</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-pastel-yellow p-3 rounded-xl mb-6">
                        <div class="text-xs text-primary-700">
                            <strong>⚠️ 중요 안내:</strong><br>
                            • 임시 비밀번호는 보안을 위해 첫 로그인 후 즉시 변경해주세요<br>
                            • 이 정보를 안전한 곳에 보관하세요<br>
                            • 로그인 후 🔐 비밀번호 변경 메뉴를 이용하세요
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="sendAccountInfo('${loginId}', '${password}', '${name}')" class="flex-1 bg-gradient-to-r from-pastel-coral to-pastel-pink text-primary-800 py-3 rounded-xl font-medium hover:shadow-soft transition-all">
                            📱 정보 전송
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 btn-primary text-white py-3 rounded-xl font-medium">
                            ✅ 확인
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 5초 후 자동으로 닫기 안내
            setTimeout(() => {
                const autoCloseText = modal.querySelector('.card-gradient');
                if (autoCloseText && modal.parentNode) {
                    const notice = document.createElement('div');
                    notice.className = 'text-xs text-primary-500 text-center mt-2';
                    notice.textContent = '5초 후 자동으로 닫힙니다...';
                    autoCloseText.appendChild(notice);
                    
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.remove();
                        }
                    }, 5000);
                }
            }, 3000);
        }

        // 클립보드 복사 함수 (Promise 반환)
        function copyToClipboard(text) {
            return new Promise((resolve, reject) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    // 최신 Clipboard API 사용
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            resolve();
                        })
                        .catch(() => {
                            // fallback 시도
                            try {
                                const textArea = document.createElement('textarea');
                                textArea.value = text;
                                textArea.style.position = 'fixed';
                                textArea.style.opacity = '0';
                                document.body.appendChild(textArea);
                                textArea.select();
                                textArea.setSelectionRange(0, 99999); // 모바일 지원
                                const successful = document.execCommand('copy');
                                document.body.removeChild(textArea);
                                
                                if (successful) {
                                    resolve();
                                } else {
                                    reject(new Error('복사 실패'));
                                }
                            } catch (err) {
                                reject(err);
                            }
                        });
                } else {
                    // 구형 브라우저 fallback
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        textArea.setSelectionRange(0, 99999);
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('복사 실패'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                }
            });
        }

        // 계정 정보 클립보드 복사
        function sendAccountInfo(loginId, password, name) {
            const message = `🎉 [운동 방 관리 시스템] 부방장 계정 생성 완료!

👤 이름: ${name}님
🆔 아이디: ${loginId}
🔐 임시 비밀번호: ${password}

⚠️ 중요 안내:
• 첫 로그인 후 반드시 비밀번호를 변경해주세요
• 로그인 → 🔐 비밀번호 변경 메뉴 이용
• 계정 정보는 안전하게 보관해주세요

🔗 접속 주소: https://gym-management1.netlify.app/

💪 함께 건강한 운동 습관을 만들어가요!`;
            
            // 클립보드에 복사
            copyToClipboard(message).then(() => {
                showMessage('📋 계정 정보가 클립보드에 복사되었습니다!\n카카오톡이나 문자로 전달해주세요! 💬', 'success');
                console.log('복사된 메시지:', message);
            }).catch(() => {
                // 클립보드 복사 실패 시 콘솔에 표시
                console.log('📋 복사할 메시지:', message);
                showMessage('📋 메시지를 콘솔에서 확인하여 복사해주세요!', 'info');
            });
        }

        // 데이터 내보내기 관련 함수들
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            setupReportMonthOptions();
            modal.classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function setupReportMonthOptions() {
            const select = document.getElementById('reportMonth');
            select.innerHTML = '';
            
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const option = document.createElement('option');
                option.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                option.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월`;
                select.appendChild(option);
            }
        }

        // CSV 형태로 데이터를 변환하는 함수
        function arrayToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // CSV에서 쉼표나 따옴표가 포함된 값은 따옴표로 감싸기
                        return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\\n');
            
            return csvContent;
        }

        // 파일 다운로드 함수
        function downloadFile(content, filename, type = 'text/csv') {
            const blob = new Blob([content], { type: type + ';charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Excel 내보내기 함수
        function exportToExcel(type) {
            let data = [];
            let filename = '';
            
            switch (type) {
                case 'members':
                    data = members.map(member => ({
                        '닉네임': member.nickname || member.name,
                        '실명': member.name,
                        '연락처': member.phone || '',
                        '역할': member.role === 'super_admin' ? '방장' : member.role === 'admin' ? '부방장' : '일반멤버',
                        '가입일': member.joinDate ? new Date(member.joinDate).toLocaleDateString('ko-KR') : '',
                        '상태': member.isActive === false ? '비활성' : '활성',
                        '현재상태': getStatusText(getMemberStatus(member))
                    }));
                    filename = `멤버목록_${new Date().toISOString().split('T')[0]}.csv`;
                    break;
                    
                case 'activities':
                    data = [];
                    Object.keys(activities).forEach(dateStr => {
                        const activity = activities[dateStr];
                        if (activity.workout) {
                            activity.workout.forEach(memberId => {
                                const member = members.find(m => m.id === memberId);
                                data.push({
                                    '날짜': dateStr,
                                    '활동': '운동',
                                    '멤버ID': memberId,
                                    '닉네임': member ? (member.nickname || member.name) : memberId,
                                    '실명': member ? member.name : '',
                                    '기록시간': activity.updatedAt ? new Date(activity.updatedAt).toLocaleString('ko-KR') : '',
                                    '기록자': activity.updatedBy || ''
                                });
                            });
                        }
                        if (activity.meeting) {
                            activity.meeting.forEach(memberId => {
                                const member = members.find(m => m.id === memberId);
                                data.push({
                                    '날짜': dateStr,
                                    '활동': '벙',
                                    '멤버ID': memberId,
                                    '닉네임': member ? (member.nickname || member.name) : memberId,
                                    '실명': member ? member.name : '',
                                    '기록시간': activity.updatedAt ? new Date(activity.updatedAt).toLocaleString('ko-KR') : '',
                                    '기록자': activity.updatedBy || ''
                                });
                            });
                        }
                    });
                    filename = `활동기록_${new Date().toISOString().split('T')[0]}.csv`;
                    break;
                    
                case 'all':
                    // 멤버별 통계 데이터
                    data = members.map(member => {
                        const workoutCount = countMemberActivity(member.id, new Date(2024, 0, 1), new Date(), 'workout');
                        const meetingCount = countMemberActivity(member.id, new Date(2024, 0, 1), new Date(), 'meeting');
                        
                        return {
                            '닉네임': member.nickname || member.name,
                            '실명': member.name,
                            '연락처': member.phone || '',
                            '역할': member.role === 'super_admin' ? '방장' : member.role === 'admin' ? '부방장' : '일반멤버',
                            '가입일': member.joinDate ? new Date(member.joinDate).toLocaleDateString('ko-KR') : '',
                            '상태': member.isActive === false ? '비활성' : '활성',
                            '현재상태': getStatusText(getMemberStatus(member)),
                            '총운동횟수': workoutCount,
                            '총벙참여횟수': meetingCount,
                            '마지막활동일': getLastActivityDate(member.id)
                        };
                    });
                    filename = `전체데이터_${new Date().toISOString().split('T')[0]}.csv`;
                    break;
            }
            
            if (data.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            const csvContent = arrayToCSV(data);
            downloadFile('\\ufeff' + csvContent, filename); // BOM 추가로 한글 깨짐 방지
            
            // 성공 메시지
            const button = document.querySelector(`#export${type.charAt(0).toUpperCase() + type.slice(1)}Excel`);
            if (button) {
                const originalText = button.textContent;
                button.textContent = '✅ 다운로드 완료!';
                button.style.background = 'linear-gradient(to right, #10b981, #059669)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }
        }

        // 멤버의 마지막 활동일 조회
        function getLastActivityDate(memberId) {
            let lastDate = '';
            
            Object.keys(activities).forEach(dateStr => {
                const activity = activities[dateStr];
                if ((activity.workout && activity.workout.includes(memberId)) ||
                    (activity.meeting && activity.meeting.includes(memberId))) {
                    if (dateStr > lastDate) {
                        lastDate = dateStr;
                    }
                }
            });
            
            return lastDate || '활동없음';
        }

        // 전체 백업 내보내기
        function exportBackup() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                members: members,
                activities: activities,
                notice: {
                    category: document.getElementById('noticeCategory')?.value || '공지',
                    text: document.getElementById('noticeText')?.value || ''
                }
            };
            
            const jsonContent = JSON.stringify(backupData, null, 2);
            const filename = `운동방백업_${new Date().toISOString().split('T')[0]}.json`;
            
            downloadFile(jsonContent, filename, 'application/json');
            
            // 성공 메시지
            const button = document.getElementById('exportBackup');
            const originalText = button.textContent;
            button.textContent = '✅ 백업 완료!';
            button.style.background = 'linear-gradient(to right, #10b981, #059669)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }

        // 백업 복원하기
        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.members || !backupData.activities) {
                        alert('올바르지 않은 백업 파일입니다.');
                        return;
                    }
                    
                    if (confirm('백업을 복원하시겠습니까? 현재 데이터는 덮어쓰여집니다.')) {
                        // 데이터 복원
                        members.length = 0;
                        members.push(...backupData.members);
                        
                        Object.keys(activities).forEach(key => delete activities[key]);
                        Object.assign(activities, backupData.activities);
                        
                        // 로컬 스토리지 업데이트
                        localStorage.setItem('localMembers', JSON.stringify(members));
                        localStorage.setItem('localActivities', JSON.stringify(activities));
                        
                        // 화면 새로고침
                        renderMemberList();
                        renderCalendar();
                        renderWeeklyDashboard();
                        renderMonthlyReport();
                        
                        alert('백업이 성공적으로 복원되었습니다.');
                        closeExportModal();
                    }
                } catch (error) {
                    console.error('백업 복원 오류:', error);
                    alert('백업 파일을 읽는 중 오류가 발생했습니다.');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // 파일 입력 초기화
        }

        // 월간 리포트 내보내기
        function exportMonthlyReport() {
            const selectedMonth = document.getElementById('reportMonth').value;
            const [year, month] = selectedMonth.split('-');
            
            const startDate = new Date(parseInt(year), parseInt(month) - 1, 1);
            const endDate = new Date(parseInt(year), parseInt(month), 0);
            
            const reportData = [];
            
            // 해당 월의 모든 활동 데이터 수집
            members.forEach(member => {
                if (member.isActive === false) return;
                
                const workoutCount = countMemberActivity(member.id, startDate, endDate, 'workout');
                const meetingCount = countMemberActivity(member.id, startDate, endDate, 'meeting');
                
                reportData.push({
                    '닉네임': member.nickname || member.name,
                    '실명': member.name,
                    '운동횟수': workoutCount,
                    '벙참여횟수': meetingCount,
                    '운동목표달성': workoutCount >= 8 ? 'O' : 'X',
                    '벙목표달성': meetingCount >= 1 ? 'O' : 'X',
                    '종합평가': (workoutCount >= 8 && meetingCount >= 1) ? '우수' : 
                               (workoutCount >= 4 || meetingCount >= 1) ? '보통' : '미흡'
                });
            });
            
            const csvContent = arrayToCSV(reportData);
            const filename = `월간리포트_${year}년${month}월.csv`;
            
            downloadFile('\\ufeff' + csvContent, filename);
            
            // 성공 메시지
            const button = document.getElementById('exportMonthlyReport');
            const originalText = button.textContent;
            button.textContent = '✅ 완료!';
            button.style.background = 'linear-gradient(to right, #10b981, #059669)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }
    </script>
</body>
</html>
